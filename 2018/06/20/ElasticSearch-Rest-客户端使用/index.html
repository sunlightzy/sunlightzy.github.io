<!DOCTYPE html>
<html lang=zh>
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="utf-8">
  
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no, minimal-ui">
  <meta name="renderer" content="webkit">
  <meta http-equiv="Cache-Control" content="no-transform">
  <meta http-equiv="Cache-Control" content="no-siteapp">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta name="format-detection" content="telephone=no,email=no,adress=no">
  <!-- Color theme for statusbar -->
  <meta name="theme-color" content="#000000">
  <!-- 强制页面在当前窗口以独立页面显示,防止别人在框架里调用页面 -->
  <meta http-equiv="window-target" content="_top">
  
  
  <title>ElasticSearch Rest 客户端使用(长文,待续...) | JerrySimple</title>
  <meta name="description" content="起步阅读文档须知,文档基于Elasticsearch 6.x,阅读要求,熟悉 ElasticSearch 的语法 兼容性高级客户端要求最低的 java 版本是1.8 ，它依赖 Elasticsearch 的核心工程，客户端的版本应该和 Elasticsearch 的版本保持一致，高级客户端和 TransportClient【TCP 连接客户端】 接受一样的请求参数，并且返回一样的响应结果，如果你想">
<meta name="keywords" content="elasticsearch">
<meta property="og:type" content="article">
<meta property="og:title" content="ElasticSearch Rest 客户端使用(长文,待续...)">
<meta property="og:url" content="https://blog.milk4j.com/2018/06/20/ElasticSearch-Rest-客户端使用/index.html">
<meta property="og:site_name" content="Jerry Simple">
<meta property="og:description" content="起步阅读文档须知,文档基于Elasticsearch 6.x,阅读要求,熟悉 ElasticSearch 的语法 兼容性高级客户端要求最低的 java 版本是1.8 ，它依赖 Elasticsearch 的核心工程，客户端的版本应该和 Elasticsearch 的版本保持一致，高级客户端和 TransportClient【TCP 连接客户端】 接受一样的请求参数，并且返回一样的响应结果，如果你想">
<meta property="og:locale" content="zh-CN">
<meta property="og:updated_time" content="2018-10-31T01:38:12.054Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="ElasticSearch Rest 客户端使用(长文,待续...)">
<meta name="twitter:description" content="起步阅读文档须知,文档基于Elasticsearch 6.x,阅读要求,熟悉 ElasticSearch 的语法 兼容性高级客户端要求最低的 java 版本是1.8 ，它依赖 Elasticsearch 的核心工程，客户端的版本应该和 Elasticsearch 的版本保持一致，高级客户端和 TransportClient【TCP 连接客户端】 接受一样的请求参数，并且返回一样的响应结果，如果你想">
  <!-- Canonical links -->
  <link rel="canonical" href="https://blog.milk4j.com/2018/06/20/ElasticSearch-Rest-客户端使用/index.html">
  
    <link rel="alternate" href="/atom.xml" title="Jerry Simple" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png" type="image/x-icon">
  
  <link rel="stylesheet" href="/css/style.css">
  
  
  
  
</head>


<body class="main-center" itemscope itemtype="https://schema.org/WebPage">
  <header class="header" itemscope="" itemtype="https://schema.org/WPHeader">
  <div class="slimContent">
    <div class="navbar-header">
      
      
      <div class="profile-block text-center">
        <a id="avatar" href="https://github.com/sunlightzy" target="_blank">
          <img class="img-circle img-rotate" src="https://oscimg.oschina.net/oscnet/ec5be0d5bdd7e3094a04a246b07bc741ff7.jpg" width="200" height="200">
        </a>
        <h2 id="name" class="hidden-xs hidden-sm">Jerry Simple</h2>
        <h3 id="title" class="hidden-xs hidden-sm hidden-md">雨天配抄书,代码配咖啡</h3>
        <small id="location" class="text-muted hidden-xs hidden-sm"><i class="icon icon-map-marker"></i> HangZhou, China</small>
      </div>
      
      <div class="search" id="search-form-wrap">

    <form class="search-form sidebar-form">
        <div class="input-group">
            <input type="text" class="search-form-input form-control" placeholder="搜索">
            <span class="input-group-btn">
                <button type="submit" class="search-form-submit btn btn-flat" onclick="return false;"><i class="icon icon-search"></i></button>
            </span>
        </div>
    </form>
    <div class="ins-search">
  <div class="ins-search-mask"></div>
  <div class="ins-search-container">
    <div class="ins-input-wrapper">
      <input type="text" class="ins-search-input" placeholder="想要查找什么..." x-webkit-speech="">
      <button type="button" class="close ins-close ins-selectable" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">×</span></button>
    </div>
    <div class="ins-section-wrapper">
      <div class="ins-section-container"></div>
    </div>
  </div>
</div>


</div>
      <button class="navbar-toggle collapsed" type="button" data-toggle="collapse" data-target="#main-navbar" aria-controls="main-navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
    </div>
    <nav id="main-navbar" class="collapse navbar-collapse" itemscope="" itemtype="https://schema.org/SiteNavigationElement" role="navigation">
      <ul class="nav navbar-nav main-nav menu-highlight">
        
        
        <li class="menu-item menu-item-home">
          <a href="/.">
            
            <i class="icon icon-home-fill"></i>
            
            <span class="menu-title">首页</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-archives">
          <a href="/archives">
            
            <i class="icon icon-archives-fill"></i>
            
            <span class="menu-title">归档</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-categories">
          <a href="/categories">
            
            <i class="icon icon-folder"></i>
            
            <span class="menu-title">分类</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-tags">
          <a href="/tags">
            
            <i class="icon icon-tags"></i>
            
            <span class="menu-title">标签</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-repository">
          <a href="/repository">
            
            <i class="icon icon-project"></i>
            
            <span class="menu-title">项目</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-books">
          <a href="/books">
            
            <i class="icon icon-book-fill"></i>
            
            <span class="menu-title">书单</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-links">
          <a href="/links">
            
            <i class="icon icon-friendship"></i>
            
            <span class="menu-title">友链</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-about">
          <a href="/about">
            
            <i class="icon icon-cup-fill"></i>
            
            <span class="menu-title">关于</span>
          </a>
        </li>
        
      </ul>
      
	
    <ul class="social-links">
    	
        <li><a href="https://github.com/sunlightzy" target="_blank" title="Github" data-toggle="tooltip" data-placement="top"><i class="icon icon-github"></i></a></li>
        
        <li><a href="/atom.xml" target="_blank" title="Rss" data-toggle="tooltip" data-placement="top"><i class="icon icon-rss"></i></a></li>
        
    </ul>

    </nav>
  </div>
</header>

  
    <aside class="sidebar" itemscope="" itemtype="https://schema.org/WPSideBar">
  <div class="slimContent">
    
      <div class="widget">
    <h3 class="widget-title">公告</h3>
    <div class="widget-body">
        <div id="board">
            <div class="content">
                <p>欢迎交流与分享经验!</p>
            </div>
        </div>
    </div>
</div>

    
      
  <div class="widget">
    <h3 class="widget-title">分类</h3>
    <div class="widget-body">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/docker/">docker</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/elasticsearch/">elasticsearch</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/hexo/">hexo</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/kotlin/">kotlin</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/mac/">mac</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/mysql/">mysql</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/spring-boot/">spring boot</a><span class="category-list-count">2</span></li></ul>
    </div>
  </div>


    
      
  <div class="widget">
    <h3 class="widget-title">标签</h3>
    <div class="widget-body">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/Junit/">Junit</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/docker/">docker</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/elasticsearch/">elasticsearch</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/h2/">h2</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/hexo/">hexo</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/kotlin/">kotlin</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/mac/">mac</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/mysql/">mysql</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/spring-boot/">spring boot</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/单元测试/">单元测试</a><span class="tag-list-count">2</span></li></ul>
    </div>
  </div>


    
      
  <div class="widget">
    <h3 class="widget-title">标签云</h3>
    <div class="widget-body tagcloud">
      <a href="/tags/Junit/" style="font-size: 13px;">Junit</a> <a href="/tags/docker/" style="font-size: 14px;">docker</a> <a href="/tags/elasticsearch/" style="font-size: 13px;">elasticsearch</a> <a href="/tags/h2/" style="font-size: 13px;">h2</a> <a href="/tags/hexo/" style="font-size: 13px;">hexo</a> <a href="/tags/kotlin/" style="font-size: 13px;">kotlin</a> <a href="/tags/mac/" style="font-size: 13px;">mac</a> <a href="/tags/mysql/" style="font-size: 14px;">mysql</a> <a href="/tags/spring-boot/" style="font-size: 14px;">spring boot</a> <a href="/tags/单元测试/" style="font-size: 14px;">单元测试</a>
    </div>
  </div>

    
      
  <div class="widget">
    <h3 class="widget-title">归档</h3>
    <div class="widget-body">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/10/">十月 2018</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/09/">九月 2018</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/06/">六月 2018</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/04/">四月 2018</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/04/">四月 2015</a><span class="archive-list-count">1</span></li></ul>
    </div>
  </div>


    
      
  <div class="widget">
    <h3 class="widget-title">最新文章</h3>
    <div class="widget-body">
      <ul class="recent-post-list list-unstyled no-thumbnail">
        
          <li>
            
            <div class="item-inner">
              <!--<p class="item-category">-->
                <!--<a class="category-link" href="/categories/mysql/">mysql</a>-->
              <!--</p>-->
              <p class="item-title">
                <a href="/2018/10/31/MySQL的一些遗忘点/" class="title">MySQL的一些遗忘点</a>
              </p>
              <p class="item-date">
                <i class="icon icon-calendar-plus"></i>
                <time datetime="2018-10-31T05:59:00.000Z" itemprop="datePublished">2018-10-31</time>
              </p>
            </div>
          </li>
          
          <li>
            
            <div class="item-inner">
              <!--<p class="item-category">-->
                <!--<a class="category-link" href="/categories/spring-boot/">spring boot</a>-->
              <!--</p>-->
              <p class="item-title">
                <a href="/2018/10/31/SpringBoot Junit单元测试/" class="title">SpringBoot Junit单元测试</a>
              </p>
              <p class="item-date">
                <i class="icon icon-calendar-plus"></i>
                <time datetime="2018-10-31T05:59:00.000Z" itemprop="datePublished">2018-10-31</time>
              </p>
            </div>
          </li>
          
          <li>
            
            <div class="item-inner">
              <!--<p class="item-category">-->
                <!--<a class="category-link" href="/categories/mysql/">mysql</a>-->
              <!--</p>-->
              <p class="item-title">
                <a href="/2018/10/31/我的ElasticSearch命令简记/" class="title">我的ElasticSearch命令简记</a>
              </p>
              <p class="item-date">
                <i class="icon icon-calendar-plus"></i>
                <time datetime="2018-10-31T05:59:00.000Z" itemprop="datePublished">2018-10-31</time>
              </p>
            </div>
          </li>
          
          <li>
            
            <div class="item-inner">
              <!--<p class="item-category">-->
                <!--<a class="category-link" href="/categories/spring-boot/">spring boot</a>-->
              <!--</p>-->
              <p class="item-title">
                <a href="/2018/10/31/SpringBoot+H2+Mybatis单元测试整合和坑/" class="title">SpringBoot+H2+Mybatis单元测试整合和坑</a>
              </p>
              <p class="item-date">
                <i class="icon icon-calendar-plus"></i>
                <time datetime="2018-10-31T05:59:00.000Z" itemprop="datePublished">2018-10-31</time>
              </p>
            </div>
          </li>
          
          <li>
            
            <div class="item-inner">
              <!--<p class="item-category">-->
                <!--<a class="category-link" href="/categories/docker/">docker</a>-->
              <!--</p>-->
              <p class="item-title">
                <a href="/2018/10/22/Docker安装nginx/" class="title">Docker安装nginx</a>
              </p>
              <p class="item-date">
                <i class="icon icon-calendar-plus"></i>
                <time datetime="2018-10-22T04:34:08.000Z" itemprop="datePublished">2018-10-22</time>
              </p>
            </div>
          </li>
          
      </ul>
    </div>
  </div>
  

    
  </div>
</aside>

  
  
<aside class="sidebar sidebar-toc collapse" id="collapseToc" itemscope="" itemtype="https://schema.org/WPSideBar">
  <div class="slimContent">
    <nav id="toc" class="article-toc">
      <h3 class="toc-title">文章目录</h3>
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#起步"><span class="toc-number">1.</span> <span class="toc-text">起步</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#兼容性"><span class="toc-number">1.1.</span> <span class="toc-text">兼容性</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Java-api-文档"><span class="toc-number">1.2.</span> <span class="toc-text">Java api 文档</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#maven-仓库"><span class="toc-number">1.3.</span> <span class="toc-text">maven 仓库</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Maven-配置"><span class="toc-number">1.3.1.</span> <span class="toc-text">Maven 配置</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Gradel-配置"><span class="toc-number">1.3.2.</span> <span class="toc-text">Gradel 配置</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#依赖"><span class="toc-number">1.4.</span> <span class="toc-text">依赖</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#初始化"><span class="toc-number">1.5.</span> <span class="toc-text">初始化</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Document-API"><span class="toc-number">2.</span> <span class="toc-text">Document API</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Index-API"><span class="toc-number">2.1.</span> <span class="toc-text">Index API</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Index-请求体"><span class="toc-number">2.1.1.</span> <span class="toc-text">Index 请求体</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#构建文档-source-的方式"><span class="toc-number">2.1.2.</span> <span class="toc-text">构建文档 source 的方式</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#可选参数"><span class="toc-number">2.1.3.</span> <span class="toc-text">可选参数</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#同步执行方式"><span class="toc-number">2.1.4.</span> <span class="toc-text">同步执行方式</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#异步执行方式"><span class="toc-number">2.1.5.</span> <span class="toc-text">异步执行方式</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#引索响应结果"><span class="toc-number">2.1.6.</span> <span class="toc-text">引索响应结果</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Get-API"><span class="toc-number">2.2.</span> <span class="toc-text">Get API</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Get-请求体"><span class="toc-number">2.2.1.</span> <span class="toc-text">Get 请求体</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#可选参数-1"><span class="toc-number">2.2.2.</span> <span class="toc-text">可选参数</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#同步执行"><span class="toc-number">2.2.3.</span> <span class="toc-text">同步执行</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#异步执行"><span class="toc-number">2.2.4.</span> <span class="toc-text">异步执行</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#响应结果"><span class="toc-number">2.2.5.</span> <span class="toc-text">响应结果</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Exists-API"><span class="toc-number">2.3.</span> <span class="toc-text">Exists API</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Exists-Request"><span class="toc-number">2.3.1.</span> <span class="toc-text">Exists Request</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#同步执行-1"><span class="toc-number">2.3.2.</span> <span class="toc-text">同步执行</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#异步执行-1"><span class="toc-number">2.3.3.</span> <span class="toc-text">异步执行</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Delete-API"><span class="toc-number">2.4.</span> <span class="toc-text">Delete API</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Delete-Request"><span class="toc-number">2.4.1.</span> <span class="toc-text">Delete Request</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#可选参数-2"><span class="toc-number">2.4.2.</span> <span class="toc-text">可选参数</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#同步执行-2"><span class="toc-number">2.4.3.</span> <span class="toc-text">同步执行</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#异步执行-2"><span class="toc-number">2.4.4.</span> <span class="toc-text">异步执行</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Delete-Response"><span class="toc-number">2.4.5.</span> <span class="toc-text">Delete Response</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Update-API"><span class="toc-number">2.5.</span> <span class="toc-text">Update API</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#UpdateRequest"><span class="toc-number">2.5.1.</span> <span class="toc-text">UpdateRequest</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#使用脚本更新文档"><span class="toc-number">2.5.2.</span> <span class="toc-text">使用脚本更新文档</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#传递部分文档作为参数来更新文档"><span class="toc-number">2.5.3.</span> <span class="toc-text">传递部分文档作为参数来更新文档</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Upserts"><span class="toc-number">2.5.4.</span> <span class="toc-text">Upserts</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#可选参数-3"><span class="toc-number">2.5.5.</span> <span class="toc-text">可选参数</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#同步执行-3"><span class="toc-number">2.5.6.</span> <span class="toc-text">同步执行</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#异步执行-3"><span class="toc-number">2.5.7.</span> <span class="toc-text">异步执行</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#UpdateResponse"><span class="toc-number">2.5.8.</span> <span class="toc-text">UpdateResponse</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Bulk-API"><span class="toc-number">2.6.</span> <span class="toc-text">Bulk API</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#BulkRequest"><span class="toc-number">2.6.1.</span> <span class="toc-text">BulkRequest</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#可选参数-4"><span class="toc-number">2.6.2.</span> <span class="toc-text">可选参数</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#同步执行-4"><span class="toc-number">2.6.3.</span> <span class="toc-text">同步执行</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#异步执行-4"><span class="toc-number">2.6.4.</span> <span class="toc-text">异步执行</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#BulkResponse"><span class="toc-number">2.6.5.</span> <span class="toc-text">BulkResponse</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#批量处理器"><span class="toc-number">2.6.6.</span> <span class="toc-text">批量处理器</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Multi-Get-API"><span class="toc-number">2.7.</span> <span class="toc-text">Multi-Get API</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Multi-Get-Request"><span class="toc-number">2.7.1.</span> <span class="toc-text">Multi-Get Request</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#可选参数-5"><span class="toc-number">2.7.2.</span> <span class="toc-text">可选参数</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#同步执行-5"><span class="toc-number">2.7.3.</span> <span class="toc-text">同步执行</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#异步执行-5"><span class="toc-number">2.7.4.</span> <span class="toc-text">异步执行</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#MultiGetResponse"><span class="toc-number">2.7.5.</span> <span class="toc-text">MultiGetResponse</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Search-API"><span class="toc-number">3.</span> <span class="toc-text">Search API</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Search-API-1"><span class="toc-number">3.1.</span> <span class="toc-text">Search API</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#SearchRequest"><span class="toc-number">3.1.1.</span> <span class="toc-text">SearchRequest</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#可选参数-6"><span class="toc-number">3.1.2.</span> <span class="toc-text">可选参数</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#使用-SearchBuilder"><span class="toc-number">3.1.3.</span> <span class="toc-text">使用 SearchBuilder</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#构建查询语句"><span class="toc-number">3.1.4.</span> <span class="toc-text">构建查询语句</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#设置排序"><span class="toc-number">3.1.5.</span> <span class="toc-text">设置排序</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#文档过滤"><span class="toc-number">3.1.6.</span> <span class="toc-text">文档过滤</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#字段高亮"><span class="toc-number">3.1.7.</span> <span class="toc-text">字段高亮</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#添加聚合查询"><span class="toc-number">3.1.8.</span> <span class="toc-text">添加聚合查询</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#请求建议词"><span class="toc-number">3.1.9.</span> <span class="toc-text">请求建议词</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#分析查询和聚合"><span class="toc-number">3.1.10.</span> <span class="toc-text">分析查询和聚合</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#同步执行-6"><span class="toc-number">3.1.11.</span> <span class="toc-text">同步执行</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#异步执行-6"><span class="toc-number">3.1.12.</span> <span class="toc-text">异步执行</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#SearchResponse"><span class="toc-number">3.1.13.</span> <span class="toc-text">SearchResponse</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#获取搜索命中的文档"><span class="toc-number">3.1.14.</span> <span class="toc-text">获取搜索命中的文档</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#获取高亮结果"><span class="toc-number">3.1.15.</span> <span class="toc-text">获取高亮结果</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#获取聚合结果"><span class="toc-number">3.1.16.</span> <span class="toc-text">获取聚合结果</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#获取建议"><span class="toc-number">3.1.17.</span> <span class="toc-text">获取建议</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#获取性能分析结果"><span class="toc-number">3.1.18.</span> <span class="toc-text">获取性能分析结果</span></a></li></ol></li></ol></li></ol>
    </nav>
  </div>
</aside>

<main class="main" role="main">
  <div class="content">
  <article id="post-ElasticSearch-Rest-客户端使用" class="article article-type-post" itemscope="" itemtype="https://schema.org/BlogPosting">
    
    <div class="article-header">
      
        
  
    <h1 class="article-title" itemprop="name">
      ElasticSearch Rest 客户端使用(长文,待续...)
    </h1>
  

      
      <div class="article-meta">
        <span class="article-date">
    <i class="icon icon-calendar-check"></i>
	<a href="/2018/06/20/ElasticSearch-Rest-客户端使用/" class="article-date">
	  <time datetime="2018-06-20T12:36:39.000Z" itemprop="datePublished">2018-06-20</time>
	</a>
</span>
        
  <span class="article-category">
    <i class="icon icon-folder"></i>
    <a class="article-category-link" href="/categories/elasticsearch/">elasticsearch</a>
  </span>

        
  <span class="article-tag">
    <i class="icon icon-tags"></i>
	<a class="article-tag-link" href="/tags/elasticsearch/">elasticsearch</a>
  </span>


        

        <span class="post-comment"><i class="icon icon-comment"></i> <a href="/2018/06/20/ElasticSearch-Rest-客户端使用/#comments" class="article-comment-link">评论</a></span>
        
	
		<span class="post-wordcount hidden-xs" itemprop="wordCount">字数统计: 7.1k(字)</span>
	
	
		<span class="post-readcount hidden-xs" itemprop="timeRequired">阅读时长: 32(分)</span>
	

      </div>
    </div>
    <div class="article-entry marked-body" itemprop="articleBody">
      
        <h2 id="起步"><a href="#起步" class="headerlink" title="起步"></a>起步</h2><p>阅读文档须知,文档基于<code>Elasticsearch 6.x</code>,阅读要求,熟悉 <code>ElasticSearch</code> 的语法</p>
<h3 id="兼容性"><a href="#兼容性" class="headerlink" title="兼容性"></a>兼容性</h3><p>高级客户端要求最低的 <code>java</code> 版本是1.8 ，它依赖 <code>Elasticsearch</code> 的核心工程，客户端的版本应该和 <code>Elasticsearch</code> 的版本保持一致，高级客户端和 <code>TransportClient</code>【TCP 连接客户端】 接受一样的请求参数，并且返回一样的响应结果，如果你想从 <code>TransportClient</code> 客户端迁移到 <code>REST</code> 客户端，请参考<a href="https://www.elastic.co/guide/en/elasticsearch/client/java-rest/6.3/java-rest-high-level-migration.html" target="_blank" rel="noopener">迁移手册</a></p>
<p>高级客户端保证能够与运行在相同主要版本和更高版本上的<code>Elasticsearch</code>节点进行通信。它不需要与通信的<code>Elasticsearch</code>节点处于相同的版本，因为它是向前兼容的，这意味着它支持与更高版本的<code>Elasticsearch</code>进行通信，而不是与其开发的版本进行通信。</p>
<p>6.0 客户端能够与任何6.x版本的 <code>Elasticsearch</code>节点通信，而6.1客户端肯定能够与6.1,6.2和任何更高版本的6.x版本通信，但在与老版的<code>Elasticsearch</code>节点通信时可能存在不兼容问题版本，例如6.1和6.0，6.1客户端为一些 <code>api</code> 添加了新的请求体字段支持，然而6.0节点却不支持。</p>
<p>建议在将<code>Elasticsearch</code>集群升级到新的主版本时升级高级客户端，因为<code>REST API</code>中断更改可能会导致意外结果，具体取决于请求所针对的节点，并且新添加的API仅支持新版本的客户端。一旦集群中的所有节点都升级到新的主版本，客户端应保持同步更新。</p>
<h3 id="Java-api-文档"><a href="#Java-api-文档" class="headerlink" title="Java api 文档"></a>Java api 文档</h3><p><a href="https://artifacts.elastic.co/javadoc/org/elasticsearch/client/elasticsearch-rest-high-level-client/6.3.1/index.html" target="_blank" rel="noopener">文档地址</a>：<code>&lt;https://artifacts.elastic.co/javadoc/org/elasticsearch/client/elasticsearch-rest-high-level-client/6.3.1/index.html&gt;</code></p>
<h3 id="maven-仓库"><a href="#maven-仓库" class="headerlink" title="maven 仓库"></a>maven 仓库</h3><p>高级Java REST客户端托管在 <a href="http://search.maven.org/#search%7Cga%7C1%7Cg%3A%22org.elasticsearch.client%22" target="_blank" rel="noopener">Maven Central上</a>。所需的最低Java版本是<code>1.8</code>。</p>
<p>高级REST客户端与Elasticsearch具有相同的发布周期。将版本替换为所需的客户端版本。</p>
<p>如果您正在寻找SNAPSHOT版本，可以通过<a href="https://snapshots.elastic.co/maven/" target="_blank" rel="noopener">https://snapshots.elastic.co/maven/</a>获取Elastic Maven Snapshot存储库。</p>
<h4 id="Maven-配置"><a href="#Maven-配置" class="headerlink" title="Maven 配置"></a>Maven 配置</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.elasticsearch.client<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>elasticsearch-rest-high-level-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>6.3.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h4 id="Gradel-配置"><a href="#Gradel-配置" class="headerlink" title="Gradel 配置"></a>Gradel 配置</h4><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">dependencies &#123;</span><br><span class="line">    compile <span class="string">'org.elasticsearch.client:elasticsearch-rest-high-level-client:6.3.1'</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="依赖"><a href="#依赖" class="headerlink" title="依赖"></a>依赖</h3><p>高级客户端依赖下面的组件及其传递依赖性：</p>
<ul>
<li>org.elasticsearch.client:elasticsearch-rest-client</li>
<li>org.elasticsearch:elasticsearch</li>
</ul>
<h3 id="初始化"><a href="#初始化" class="headerlink" title="初始化"></a>初始化</h3><p>一个<code>RestHighLevelClient</code>实例需要一个<a href="https://www.elastic.co/guide/en/elasticsearch/client/java-rest/6.3/java-rest-low-usage-initialization.html" target="_blank" rel="noopener">低级客户端的Builder</a> 来构建如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">RestHighLevelClient client = <span class="keyword">new</span> RestHighLevelClient(</span><br><span class="line">        RestClient.builder(</span><br><span class="line">                <span class="keyword">new</span> HttpHost(<span class="string">"localhost"</span>, <span class="number">9200</span>, <span class="string">"http"</span>),</span><br><span class="line">                <span class="keyword">new</span> HttpHost(<span class="string">"localhost"</span>, <span class="number">9201</span>, <span class="string">"http"</span>)));</span><br></pre></td></tr></table></figure>
<p>高级客户端将在内部创建用于执行请求的低级客户端，低级客户端基于框架提供的<code>builder</code>，并管理其生命周期。</p>
<p>高级客户端实例应该在不再需要时关闭，以便正确释放它使用的所有资源，以及底层的http客户端实例及其线程。这可以通过<code>close</code> 方法完成，该方法将关闭内部<code>RestClient</code>实例。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">client.close();</span><br></pre></td></tr></table></figure>
<h2 id="Document-API"><a href="#Document-API" class="headerlink" title="Document API"></a>Document API</h2><p>Java高级REST客户端支持以下文档API：</p>
<p>单文档API：</p>
<ul>
<li>index api - 索引API</li>
<li>get api - 获取API</li>
<li>delete api - 删除API</li>
<li>update api - 更新API</li>
</ul>
<p>多文档API</p>
<ul>
<li>bulk api - 批量操作 api</li>
<li>Multi-Get API - 批量获取 api</li>
</ul>
<h3 id="Index-API"><a href="#Index-API" class="headerlink" title="Index API"></a>Index API</h3><h4 id="Index-请求体"><a href="#Index-请求体" class="headerlink" title="Index 请求体"></a>Index 请求体</h4><p>一个引索请求需要下面的参数：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">IndexRequest request = <span class="keyword">new</span> IndexRequest(</span><br><span class="line">        <span class="string">"posts"</span>, <span class="comment">//index 名</span></span><br><span class="line">        <span class="string">"doc"</span>,  <span class="comment">//type 名</span></span><br><span class="line">        <span class="string">"1"</span>);   <span class="comment">//文档 ID</span></span><br><span class="line">String jsonString = <span class="string">"&#123;"</span> +</span><br><span class="line">        <span class="string">"\"user\":\"kimchy\","</span> +</span><br><span class="line">        <span class="string">"\"postDate\":\"2013-01-30\","</span> +</span><br><span class="line">        <span class="string">"\"message\":\"trying out Elasticsearch\""</span> +</span><br><span class="line">        <span class="string">"&#125;"</span>;</span><br><span class="line">request.source(jsonString, XContentType.JSON);<span class="comment">//设置 string 类型的文档source</span></span><br></pre></td></tr></table></figure>
<h4 id="构建文档-source-的方式"><a href="#构建文档-source-的方式" class="headerlink" title="构建文档 source 的方式"></a>构建文档 source 的方式</h4><p>除了<code>String</code>上面显示的示例之外，还可以以不同方式提供文档源 ：</p>
<p>方式一：以 <code>Map</code> 的方式提供的文档源，<code>Map</code>自动转换为<code>JSON</code>格式</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Map&lt;String, Object&gt; jsonMap = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">jsonMap.put(<span class="string">"user"</span>, <span class="string">"kimchy"</span>);</span><br><span class="line">jsonMap.put(<span class="string">"postDate"</span>, <span class="keyword">new</span> Date());</span><br><span class="line">jsonMap.put(<span class="string">"message"</span>, <span class="string">"trying out Elasticsearch"</span>);</span><br><span class="line">IndexRequest indexRequest = <span class="keyword">new</span> IndexRequest(<span class="string">"posts"</span>, <span class="string">"doc"</span>, <span class="string">"1"</span>)</span><br><span class="line">        .source(jsonMap);</span><br></pre></td></tr></table></figure>
<p>方式二：以<code>XContentBuilder</code>对象方式提供，<code>Elasticsearch</code>内置了<code>helper</code>生成<code>JSON</code>内容</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">XContentBuilder builder = XContentFactory.jsonBuilder();</span><br><span class="line">builder.startObject();</span><br><span class="line">&#123;</span><br><span class="line">    builder.field(<span class="string">"user"</span>, <span class="string">"kimchy"</span>);</span><br><span class="line">    builder.timeField(<span class="string">"postDate"</span>, <span class="keyword">new</span> Date());</span><br><span class="line">    builder.field(<span class="string">"message"</span>, <span class="string">"trying out Elasticsearch"</span>);</span><br><span class="line">&#125;</span><br><span class="line">builder.endObject();</span><br><span class="line">IndexRequest indexRequest = <span class="keyword">new</span> IndexRequest(<span class="string">"posts"</span>, <span class="string">"doc"</span>, <span class="string">"1"</span>)</span><br><span class="line">        .source(builder);</span><br></pre></td></tr></table></figure>
<p>方式三：以键值对方式提供，转换为<code>JSON</code>格式</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">IndexRequest indexRequest = <span class="keyword">new</span> IndexRequest(<span class="string">"posts"</span>, <span class="string">"doc"</span>, <span class="string">"1"</span>)</span><br><span class="line">        .source(<span class="string">"user"</span>, <span class="string">"kimchy"</span>,</span><br><span class="line">                <span class="string">"postDate"</span>, <span class="keyword">new</span> Date(),</span><br><span class="line">                <span class="string">"message"</span>, <span class="string">"trying out Elasticsearch"</span>);</span><br></pre></td></tr></table></figure>
<h4 id="可选参数"><a href="#可选参数" class="headerlink" title="可选参数"></a>可选参数</h4><p>可以选择以下参数：</p>
<ul>
<li>设置路由</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">request.routing(<span class="string">"routing"</span>);</span><br></pre></td></tr></table></figure>
<ul>
<li>设置父文档</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">request.parent(<span class="string">"parent"</span>);</span><br></pre></td></tr></table></figure>
<ul>
<li>设置超时时间</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">request.timeout(TimeValue.timeValueSeconds(<span class="number">1</span>));</span><br><span class="line">request.timeout(<span class="string">"1s"</span>);</span><br></pre></td></tr></table></figure>
<ul>
<li>设置刷新策略</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">request.setRefreshPolicy(WriteRequest.RefreshPolicy.WAIT_UNTIL);</span><br><span class="line">request.setRefreshPolicy(<span class="string">"wait_for"</span>);</span><br></pre></td></tr></table></figure>
<ul>
<li>设置版本</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">request.version(<span class="number">2</span>);</span><br></pre></td></tr></table></figure>
<ul>
<li>设置版本类型</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">request.versionType(VersionType.EXTERNAL);</span><br></pre></td></tr></table></figure>
<ul>
<li>设置文档操作类型</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">request.opType(DocWriteRequest.OpType.CREATE); </span><br><span class="line">request.opType(<span class="string">"create"</span>);</span><br></pre></td></tr></table></figure>
<ul>
<li>文档执行之前，设置 <code>pipeline</code> 名</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">request.setPipeline(&quot;pipeline&quot;);</span><br></pre></td></tr></table></figure>
<h4 id="同步执行方式"><a href="#同步执行方式" class="headerlink" title="同步执行方式"></a>同步执行方式</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">IndexResponse indexResponse = client.index(request);</span><br></pre></td></tr></table></figure>
<h4 id="异步执行方式"><a href="#异步执行方式" class="headerlink" title="异步执行方式"></a>异步执行方式</h4><p>索引请求的异步执行需要将<code>IndexRequest</code> 实例和<code>ActionListener</code>实例都传递给异步方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">ActionListener&lt;IndexResponse&gt; listener = <span class="keyword">new</span> ActionListener&lt;IndexResponse&gt;() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onResponse</span><span class="params">(IndexResponse indexResponse)</span> </span>&#123;  </span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onFailure</span><span class="params">(Exception e)</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line">IndexResponse indexResponse = client.index(request);</span><br></pre></td></tr></table></figure>
<p>异步方法不会阻塞并立即返回。一旦完成，如果执行成功，则使用该方法<code>ActionListener</code>回调<code>onResponse</code>，如果失败则回调<code>onFailure</code>方法。</p>
<h4 id="引索响应结果"><a href="#引索响应结果" class="headerlink" title="引索响应结果"></a>引索响应结果</h4><p>返回的<code>IndexResponse</code>包含了有关已执行操作的信息，如下所示：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">String index = indexResponse.getIndex();</span><br><span class="line">String type = indexResponse.getType();</span><br><span class="line">String id = indexResponse.getId();</span><br><span class="line"><span class="keyword">long</span> version = indexResponse.getVersion();</span><br><span class="line"><span class="keyword">if</span> (indexResponse.getResult() == DocWriteResponse.Result.CREATED) &#123;</span><br><span class="line">    <span class="comment">//创建文档操作</span></span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (indexResponse.getResult() == DocWriteResponse.Result.UPDATED) &#123;</span><br><span class="line">    <span class="comment">//更新文档操作</span></span><br><span class="line">&#125;</span><br><span class="line">ReplicationResponse.ShardInfo shardInfo = indexResponse.getShardInfo();</span><br><span class="line"><span class="keyword">if</span> (shardInfo.getTotal() != shardInfo.getSuccessful()) &#123;</span><br><span class="line">    <span class="comment">//处理成功分片数小于总分片数的情况</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (shardInfo.getFailed() &gt; <span class="number">0</span>) &#123;<span class="comment">//理潜在的失败情况</span></span><br><span class="line">    <span class="keyword">for</span> (ReplicationResponse.ShardInfo.Failure failure : shardInfo.getFailures()) &#123;</span><br><span class="line">        String reason = failure.reason(); </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如果存在文档版本冲突，则会抛出<code>ElasticsearchException</code>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">IndexRequest request = <span class="keyword">new</span> IndexRequest(<span class="string">"posts"</span>, <span class="string">"doc"</span>, <span class="string">"1"</span>)</span><br><span class="line">        .source(<span class="string">"field"</span>, <span class="string">"value"</span>)</span><br><span class="line">        .version(<span class="number">1</span>);</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    IndexResponse response = client.index(request);</span><br><span class="line">&#125; <span class="keyword">catch</span>(ElasticsearchException e) &#123;</span><br><span class="line">    <span class="keyword">if</span> (e.status() == RestStatus.CONFLICT) &#123;</span><br><span class="line">        <span class="comment">//引发的异常表示返回了版本冲突错误</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如果已存在具有相同索引，类型和ID的文档，<code>opType</code>设置为<code>create</code>也会发生冲突：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">IndexRequest request = <span class="keyword">new</span> IndexRequest(<span class="string">"posts"</span>, <span class="string">"doc"</span>, <span class="string">"1"</span>)</span><br><span class="line">        .source(<span class="string">"field"</span>, <span class="string">"value"</span>)</span><br><span class="line">        .opType(DocWriteRequest.OpType.CREATE);</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    IndexResponse response = client.index(request);</span><br><span class="line">&#125; <span class="keyword">catch</span>(ElasticsearchException e) &#123;</span><br><span class="line">    <span class="keyword">if</span> (e.status() == RestStatus.CONFLICT) &#123;</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Get-API"><a href="#Get-API" class="headerlink" title="Get API"></a>Get API</h3><h4 id="Get-请求体"><a href="#Get-请求体" class="headerlink" title="Get 请求体"></a>Get 请求体</h4><p>构建 GetRequest 的参数如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GetRequest getRequest = <span class="keyword">new</span> GetRequest(<span class="string">"posts"</span>,<span class="string">"doc"</span>,<span class="string">"1"</span>);</span><br></pre></td></tr></table></figure>
<h4 id="可选参数-1"><a href="#可选参数-1" class="headerlink" title="可选参数"></a>可选参数</h4><ul>
<li>设置返回响应不包含任何字段，默认情况下返回响应包含该所有字段</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">request.fetchSourceContext(FetchSourceContext.DO_NOT_FETCH_SOURCE);</span><br></pre></td></tr></table></figure>
<ul>
<li>配置返回响应包含哪些字段</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">String[] includes = <span class="keyword">new</span> String[]&#123;<span class="string">"message"</span>, <span class="string">"*Date"</span>&#125;;</span><br><span class="line">String[] excludes = Strings.EMPTY_ARRAY;</span><br><span class="line">FetchSourceContext fetchSourceContext =</span><br><span class="line">        <span class="keyword">new</span> FetchSourceContext(<span class="keyword">true</span>, includes, excludes);</span><br><span class="line">request.fetchSourceContext(fetchSourceContext);</span><br></pre></td></tr></table></figure>
<ul>
<li>设置返回响应不包含哪些字段</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">String[] includes = Strings.EMPTY_ARRAY;</span><br><span class="line">String[] excludes = <span class="keyword">new</span> String[]&#123;<span class="string">"message"</span>&#125;;</span><br><span class="line">FetchSourceContext fetchSourceContext =</span><br><span class="line">        <span class="keyword">new</span> FetchSourceContext(<span class="keyword">true</span>, includes, excludes);</span><br><span class="line">request.fetchSourceContext(fetchSourceContext);</span><br></pre></td></tr></table></figure>
<ul>
<li>设置检索哪些存储字段</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">request.storedFields(<span class="string">"message"</span>); <span class="comment">//为特定存储字段配置检索 (要求在映射中单独存储字段)</span></span><br><span class="line">GetResponse getResponse = client.get(request);</span><br><span class="line">String message = getResponse.getField(<span class="string">"message"</span>).getValue();<span class="comment">//获取message存储的值 (要求将字段单独存储在映射中)</span></span><br></pre></td></tr></table></figure>
<ul>
<li>设置路由</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">request.routing(<span class="string">"routing"</span>);</span><br></pre></td></tr></table></figure>
<ul>
<li>设置父文档</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">request.parent(<span class="string">"parent"</span>);</span><br></pre></td></tr></table></figure>
<ul>
<li>设置偏好</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">request.preference(<span class="string">"preference"</span>);</span><br></pre></td></tr></table></figure>
<ul>
<li>设置实时标识，默认 <code>true</code></li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">request.realtime(<span class="keyword">false</span>);</span><br></pre></td></tr></table></figure>
<ul>
<li>设置每次获取文档之前是否执行刷新操作，默认 <code>false</code></li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">request.refresh(<span class="keyword">true</span>);</span><br></pre></td></tr></table></figure>
<ul>
<li>设置版本号</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">request.version(<span class="number">2</span>);</span><br></pre></td></tr></table></figure>
<ul>
<li>设置版本类型</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">request.versionType(VersionType.EXTERNAL);</span><br></pre></td></tr></table></figure>
<h4 id="同步执行"><a href="#同步执行" class="headerlink" title="同步执行"></a>同步执行</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GetResponse getResponse = client.get(getRequest);</span><br></pre></td></tr></table></figure>
<h4 id="异步执行"><a href="#异步执行" class="headerlink" title="异步执行"></a>异步执行</h4><p><code>get</code>请求的异步执行需要将GetRequest 实例和ActionListener实例都传递给异步方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">ActionListener&lt;GetResponse&gt; listener = <span class="keyword">new</span> ActionListener&lt;GetResponse&gt;() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onResponse</span><span class="params">(GetResponse getResponse)</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onFailure</span><span class="params">(Exception e)</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line">GetResponse getResponse = client.get(getRequest);</span><br></pre></td></tr></table></figure>
<p>异步方法不会阻塞并立即返回。一旦完成，如果执行成功，则使用该方法<code>ActionListener</code>回调<code>onResponse</code>，如果失败则回调<code>onFailure</code>方法。</p>
<h4 id="响应结果"><a href="#响应结果" class="headerlink" title="响应结果"></a>响应结果</h4><p>返回的<code>IndexResponse</code>包含了有关已执行操作的信息，如下所示：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">String index = getResponse.getIndex();</span><br><span class="line">String type = getResponse.getType();</span><br><span class="line">String id = getResponse.getId();</span><br><span class="line"><span class="keyword">if</span> (getResponse.isExists()) &#123;</span><br><span class="line">    <span class="keyword">long</span> version = getResponse.getVersion();</span><br><span class="line">    String sourceAsString = getResponse.getSourceAsString();        </span><br><span class="line">    Map&lt;String, Object&gt; sourceAsMap = getResponse.getSourceAsMap(); </span><br><span class="line">    <span class="keyword">byte</span>[] sourceAsBytes = getResponse.getSourceAsBytes();          </span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">//处理未找到文档的方案。注意，虽然返回的响应具有404状态代码，但他会返回一个有效GetResponse而不是抛出异常。此类响应不包含任何文档字段，而且isExists方法返回false。</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>当对不存在的索引(<code>index</code>)执行get请求时，响应会有<code>404</code>状态代码，但是会抛出<code>ElasticsearchException</code>，需要按如下方式处理：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">GetRequest request = <span class="keyword">new</span> GetRequest(<span class="string">"does_not_exist"</span>, <span class="string">"doc"</span>, <span class="string">"1"</span>);</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    GetResponse getResponse = client.get(request);</span><br><span class="line">&#125; <span class="keyword">catch</span> (ElasticsearchException e) &#123;</span><br><span class="line">    <span class="keyword">if</span> (e.status() == RestStatus.NOT_FOUND) &#123;</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如果请求特定版本的文档，并且现有文档具有不同的版本号，则会引发版本冲突：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    GetRequest request = <span class="keyword">new</span> GetRequest(<span class="string">"posts"</span>, <span class="string">"doc"</span>, <span class="string">"1"</span>).version(<span class="number">2</span>);</span><br><span class="line">    GetResponse getResponse = client.get(request);</span><br><span class="line">&#125; <span class="keyword">catch</span> (ElasticsearchException exception) &#123;</span><br><span class="line">    <span class="keyword">if</span> (exception.status() == RestStatus.CONFLICT) &#123;</span><br><span class="line">        <span class="comment">//处理版本冲突</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Exists-API"><a href="#Exists-API" class="headerlink" title="Exists API"></a>Exists API</h3><p>如果文档存在就返回 <code>true</code>，否则返回 <code>false</code></p>
<h4 id="Exists-Request"><a href="#Exists-Request" class="headerlink" title="Exists Request"></a>Exists Request</h4><p>它的<code>GetRequest</code>就像<em>Get API</em>一样。支持所有可选参数 。由于<code>exists()</code>只返回<code>true</code>或<code>false</code>，所有建议关闭返回<code>_source</code>和任何存储的字段，以便请求更加轻量：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">GetRequest getRequest = <span class="keyword">new</span> GetRequest(</span><br><span class="line">    <span class="string">"posts"</span>, </span><br><span class="line">    <span class="string">"doc"</span>,   </span><br><span class="line">    <span class="string">"1"</span>);    </span><br><span class="line">getRequest.fetchSourceContext(<span class="keyword">new</span> FetchSourceContext(<span class="keyword">false</span>)); <span class="comment">//不返回_source</span></span><br><span class="line">getRequest.storedFields(<span class="string">"_none_"</span>);  <span class="comment">//不返回存储字段</span></span><br></pre></td></tr></table></figure>
<h4 id="同步执行-1"><a href="#同步执行-1" class="headerlink" title="同步执行"></a>同步执行</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">boolean</span> exists = client.exists(getRequest);</span><br></pre></td></tr></table></figure>
<h4 id="异步执行-1"><a href="#异步执行-1" class="headerlink" title="异步执行"></a>异步执行</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">ActionListener&lt;Boolean&gt; listener = <span class="keyword">new</span> ActionListener&lt;Boolean&gt;() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onResponse</span><span class="params">(Boolean exists)</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onFailure</span><span class="params">(Exception e)</span> </span>&#123;  </span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line">client.existsAsync(getRequest, listener);</span><br></pre></td></tr></table></figure>
<h3 id="Delete-API"><a href="#Delete-API" class="headerlink" title="Delete API"></a>Delete API</h3><h4 id="Delete-Request"><a href="#Delete-Request" class="headerlink" title="Delete Request"></a>Delete Request</h4><p><code>DeleteRequest</code> 参数如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DeleteRequest request = <span class="keyword">new</span> DeleteRequest(<span class="string">"posts"</span>,<span class="string">"doc"</span>,<span class="string">"1"</span>);</span><br></pre></td></tr></table></figure>
<h4 id="可选参数-2"><a href="#可选参数-2" class="headerlink" title="可选参数"></a>可选参数</h4><ul>
<li>设置路由</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">request.routing(<span class="string">"routing"</span>);</span><br></pre></td></tr></table></figure>
<ul>
<li>设置父文档</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">request.parent(<span class="string">"parent"</span>);</span><br></pre></td></tr></table></figure>
<ul>
<li>设置超时</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">request.timeout(TimeValue.timeValueMinutes(<span class="number">2</span>)); </span><br><span class="line">request.timeout(<span class="string">"2m"</span>);</span><br></pre></td></tr></table></figure>
<ul>
<li>设置刷新策略</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">request.setRefreshPolicy(WriteRequest.RefreshPolicy.WAIT_UNTIL); </span><br><span class="line">request.setRefreshPolicy(<span class="string">"wait_for"</span>);</span><br></pre></td></tr></table></figure>
<ul>
<li>设置版本号</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">request.version(<span class="number">2</span>);</span><br></pre></td></tr></table></figure>
<ul>
<li>设置版本类型</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">request.versionType(VersionType.EXTERNAL);</span><br></pre></td></tr></table></figure>
<h4 id="同步执行-2"><a href="#同步执行-2" class="headerlink" title="同步执行"></a>同步执行</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DeleteResponse deleteResponse = client.delete(request);</span><br></pre></td></tr></table></figure>
<h4 id="异步执行-2"><a href="#异步执行-2" class="headerlink" title="异步执行"></a>异步执行</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">ActionListener&lt;DeleteResponse&gt; listener = <span class="keyword">new</span> ActionListener&lt;DeleteResponse&gt;() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onResponse</span><span class="params">(DeleteResponse deleteResponse)</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onFailure</span><span class="params">(Exception e)</span> </span>&#123; </span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line">client.deleteAsync(request, listener);</span><br></pre></td></tr></table></figure>
<h4 id="Delete-Response"><a href="#Delete-Response" class="headerlink" title="Delete Response"></a>Delete Response</h4><p>返回的<code>DeleteResponse</code>包含了有关已执行操作的信息，如下所示：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">String index = deleteResponse.getIndex();</span><br><span class="line">String type = deleteResponse.getType();</span><br><span class="line">String id = deleteResponse.getId();</span><br><span class="line"><span class="keyword">long</span> version = deleteResponse.getVersion();</span><br><span class="line">ReplicationResponse.ShardInfo shardInfo = deleteResponse.getShardInfo();</span><br><span class="line"><span class="keyword">if</span> (shardInfo.getTotal() != shardInfo.getSuccessful()) &#123;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (shardInfo.getFailed() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">for</span> (ReplicationResponse.ShardInfo.Failure failure : shardInfo.getFailures()) &#123;</span><br><span class="line">        String reason = failure.reason(); </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>它还可以检查文档是否存在</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">DeleteRequest request = <span class="keyword">new</span> DeleteRequest(<span class="string">"posts"</span>, <span class="string">"doc"</span>, <span class="string">"does_not_exist"</span>);</span><br><span class="line">DeleteResponse deleteResponse = client.delete(request);</span><br><span class="line"><span class="keyword">if</span> (deleteResponse.getResult() == DocWriteResponse.Result.NOT_FOUND) &#123;</span><br><span class="line">    <span class="comment">//如果找不到要删除的文档</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如果请求的文档版本冲突，会抛<code>ElasticsearchException</code>异常</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    DeleteRequest request = <span class="keyword">new</span> DeleteRequest(<span class="string">"posts"</span>, <span class="string">"doc"</span>, <span class="string">"1"</span>).version(<span class="number">2</span>);</span><br><span class="line">    DeleteResponse deleteResponse = client.delete(request);</span><br><span class="line">&#125; <span class="keyword">catch</span> (ElasticsearchException exception) &#123;</span><br><span class="line">    <span class="keyword">if</span> (exception.status() == RestStatus.CONFLICT) &#123;</span><br><span class="line">        <span class="comment">//引发的异常表示返回了版本冲突错误</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Update-API"><a href="#Update-API" class="headerlink" title="Update API"></a>Update API</h3><h4 id="UpdateRequest"><a href="#UpdateRequest" class="headerlink" title="UpdateRequest"></a>UpdateRequest</h4><p>参数如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">UpdateRequest request = <span class="keyword">new</span> UpdateRequest(<span class="string">"posts"</span>, <span class="string">"doc"</span>, <span class="string">"1"</span>);</span><br></pre></td></tr></table></figure>
<p><code>Update API</code>允许使用脚本或传递部分文档来更新现有文档。</p>
<h4 id="使用脚本更新文档"><a href="#使用脚本更新文档" class="headerlink" title="使用脚本更新文档"></a>使用脚本更新文档</h4><p>使用内联脚本</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Map&lt;String, Object&gt; parameters = singletonMap(<span class="string">"count"</span>, <span class="number">4</span>); <span class="comment">//使用Map对象作为脚本参数</span></span><br><span class="line">Script inline = <span class="keyword">new</span> Script(ScriptType.INLINE, <span class="string">"painless"</span>,</span><br><span class="line">        <span class="string">"ctx._source.field += params.count"</span>, parameters);  <span class="comment">//使用painless语言和提供的参数创建内联脚本</span></span><br><span class="line">UpdateRequest request = <span class="keyword">new</span> UpdateRequest(<span class="string">"posts"</span>, <span class="string">"doc"</span>, <span class="string">"1"</span>);</span><br><span class="line">request.script(inline); <span class="comment">//将脚本设置为更新请求</span></span><br></pre></td></tr></table></figure>
<p>或者使用存储在es 中的脚本</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Script stored =<span class="keyword">new</span> Script(ScriptType.STORED, <span class="keyword">null</span>, <span class="string">"increment-field"</span>, parameters);<span class="comment">//使用存储在 es 中的painless脚本，脚本名为increment-field</span></span><br><span class="line">request.script(stored);</span><br></pre></td></tr></table></figure>
<h4 id="传递部分文档作为参数来更新文档"><a href="#传递部分文档作为参数来更新文档" class="headerlink" title="传递部分文档作为参数来更新文档"></a>传递部分文档作为参数来更新文档</h4><p>当使用部分文档来更新现有的文档时，部分文档将与现有文档合并。</p>
<p>部分文档可以以不同方式提供：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">UpdateRequest request = <span class="keyword">new</span> UpdateRequest(<span class="string">"posts"</span>, <span class="string">"doc"</span>, <span class="string">"1"</span>);</span><br><span class="line">String jsonString = <span class="string">"&#123;"</span> +</span><br><span class="line">        <span class="string">"\"updated\":\"2017-01-01\","</span> +</span><br><span class="line">        <span class="string">"\"reason\":\"daily update\""</span> +</span><br><span class="line">        <span class="string">"&#125;"</span>;</span><br><span class="line">request.doc(jsonString, XContentType.JSON);<span class="comment">//用json格式的字符串作为部分文档源</span></span><br></pre></td></tr></table></figure>
<p>以 <code>Map</code> 提供部分文档源，会被自动转化成 <code>json</code> 格式，如下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Map&lt;String, Object&gt; jsonMap = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">jsonMap.put(<span class="string">"updated"</span>, <span class="keyword">new</span> Date());</span><br><span class="line">jsonMap.put(<span class="string">"reason"</span>, <span class="string">"daily update"</span>);</span><br><span class="line">UpdateRequest request = <span class="keyword">new</span> UpdateRequest(<span class="string">"posts"</span>, <span class="string">"doc"</span>, <span class="string">"1"</span>)</span><br><span class="line">        .doc(jsonMap);</span><br></pre></td></tr></table></figure>
<p>用<code>XContentBuilder</code>对象作为部分文档源，<code>Elasticsearch</code>内置的 helpers 会自动将它转化为 json 文档</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">XContentBuilder builder = XContentFactory.jsonBuilder();</span><br><span class="line">builder.startObject();</span><br><span class="line">&#123;</span><br><span class="line">    builder.timeField(<span class="string">"updated"</span>, <span class="keyword">new</span> Date());</span><br><span class="line">    builder.field(<span class="string">"reason"</span>, <span class="string">"daily update"</span>);</span><br><span class="line">&#125;</span><br><span class="line">builder.endObject();</span><br><span class="line">UpdateRequest request = <span class="keyword">new</span> UpdateRequest(<span class="string">"posts"</span>, <span class="string">"doc"</span>, <span class="string">"1"</span>)</span><br><span class="line">        .doc(builder);</span><br></pre></td></tr></table></figure>
<p> 使用键值对作为部分文档源，他会被转换成 json 文本</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">UpdateRequest request = <span class="keyword">new</span> UpdateRequest(<span class="string">"posts"</span>, <span class="string">"doc"</span>, <span class="string">"1"</span>)</span><br><span class="line">        .doc(<span class="string">"updated"</span>, <span class="keyword">new</span> Date(),</span><br><span class="line">             <span class="string">"reason"</span>, <span class="string">"daily update"</span>);</span><br></pre></td></tr></table></figure>
<h4 id="Upserts"><a href="#Upserts" class="headerlink" title="Upserts"></a>Upserts</h4><p>如果文档尚不存在，则可以使用以下<code>upsert</code>方法来将它作为新文档插入：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">String jsonString = <span class="string">"&#123;\"created\":\"2017-01-01\"&#125;"</span>;</span><br><span class="line">request.upsert(jsonString, XContentType.JSON);</span><br></pre></td></tr></table></figure>
<p>和部分文档更新一样，<code>upsert</code> 方法接受<code>String</code>, <code>Map</code>, <code>XContentBuilder</code> or 键值对作为入参</p>
<h4 id="可选参数-3"><a href="#可选参数-3" class="headerlink" title="可选参数"></a>可选参数</h4><ul>
<li>设置路由</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">request.routing(<span class="string">"routing"</span>);</span><br></pre></td></tr></table></figure>
<ul>
<li>设置父文档</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">request.parent(<span class="string">"parent"</span>);</span><br></pre></td></tr></table></figure>
<ul>
<li>设置超时时间</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">request.timeout(TimeValue.timeValueSeconds(<span class="number">1</span>)); </span><br><span class="line">request.timeout(<span class="string">"1s"</span>);</span><br></pre></td></tr></table></figure>
<ul>
<li>设置刷新策略</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">request.setRefreshPolicy(WriteRequest.RefreshPolicy.WAIT_UNTIL); </span><br><span class="line">request.setRefreshPolicy(<span class="string">"wait_for"</span>);</span><br></pre></td></tr></table></figure>
<ul>
<li>设置重试更新操作的次数</li>
</ul>
<p>如果要更新的文档已在更新操作的get和indexing阶段之间的另一个操作更改，则重试</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">request.retryOnConflict(<span class="number">3</span>);</span><br></pre></td></tr></table></figure>
<ul>
<li>设置是否获取新文档内容，默认 <code>false</code></li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">request.fetchSource(<span class="keyword">true</span>);</span><br></pre></td></tr></table></figure>
<ul>
<li>指定返回哪些字段</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">String[] includes = <span class="keyword">new</span> String[]&#123;<span class="string">"updated"</span>, <span class="string">"r*"</span>&#125;;<span class="comment">//正则匹配</span></span><br><span class="line">String[] excludes = Strings.EMPTY_ARRAY;</span><br><span class="line">request.fetchSource(<span class="keyword">new</span> FetchSourceContext(<span class="keyword">true</span>, includes, excludes));</span><br></pre></td></tr></table></figure>
<ul>
<li>指定不返回哪些字段</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">String[] includes = <span class="keyword">new</span> String[]&#123;<span class="string">"updated"</span>, <span class="string">"r*"</span>&#125;;</span><br><span class="line">String[] excludes = Strings.EMPTY_ARRAY;</span><br><span class="line">request.fetchSource(<span class="keyword">new</span> FetchSourceContext(<span class="keyword">true</span>, includes, excludes));</span><br></pre></td></tr></table></figure>
<ul>
<li>设置文档版本号</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">request.version(<span class="number">2</span>);</span><br></pre></td></tr></table></figure>
<ul>
<li>设置是否启用noop 检测</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">request.detectNoop(<span class="keyword">false</span>);</span><br></pre></td></tr></table></figure>
<ul>
<li>指示脚本必须运行，无论文档是否存在，即如果文档尚不存在，脚本将负责创建文档</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">request.scriptedUpsert(<span class="keyword">true</span>);</span><br></pre></td></tr></table></figure>
<ul>
<li>如果文档不存在，则表明必须将部分文档用作upsert文档</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">request.docAsUpsert(<span class="keyword">true</span>);</span><br></pre></td></tr></table></figure>
<ul>
<li>设置在执行更新操作之前必须处于活动状态的分片副本数</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">request.waitForActiveShards(<span class="number">2</span>); </span><br><span class="line">request.waitForActiveShards(ActiveShardCount.ALL);</span><br></pre></td></tr></table></figure>
<h4 id="同步执行-3"><a href="#同步执行-3" class="headerlink" title="同步执行"></a>同步执行</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">UpdateResponse updateResponse = client.update(request);</span><br></pre></td></tr></table></figure>
<h4 id="异步执行-3"><a href="#异步执行-3" class="headerlink" title="异步执行"></a>异步执行</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">client.updateAsync(request, <span class="keyword">new</span> ActionListener&lt;UpdateResponse&gt;() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onResponse</span><span class="params">(UpdateResponse updateResponse)</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onFailure</span><span class="params">(Exception e)</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h4 id="UpdateResponse"><a href="#UpdateResponse" class="headerlink" title="UpdateResponse"></a>UpdateResponse</h4><p>返回的<code>UpdateResponse</code>包含了有关已执行操作的信息，如下所示：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">String index = updateResponse.getIndex();</span><br><span class="line">String type = updateResponse.getType();</span><br><span class="line">String id = updateResponse.getId();</span><br><span class="line"><span class="keyword">long</span> version = updateResponse.getVersion();</span><br><span class="line"><span class="keyword">if</span> (updateResponse.getResult() == DocWriteResponse.Result.CREATED) &#123;</span><br><span class="line">    <span class="comment">//首次创建文档（upsert）</span></span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (updateResponse.getResult() == DocWriteResponse.Result.UPDATED) &#123;</span><br><span class="line">    <span class="comment">//文档更新</span></span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (updateResponse.getResult() == DocWriteResponse.Result.DELETED) &#123;</span><br><span class="line">    <span class="comment">//文档更新</span></span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (updateResponse.getResult() == DocWriteResponse.Result.NOOP) &#123;</span><br><span class="line">    <span class="comment">//文档未受更新影响，即未对文档执行任何操作（noop）</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>UpdateRequest</code> 通过<code>fetchSource</code>方法启用获取文档功能时，响应包含更新文档的来源：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">GetResult result = updateResponse.getGetResult(); </span><br><span class="line"><span class="keyword">if</span> (result.isExists()) &#123;</span><br><span class="line">    String sourceAsString = result.sourceAsString(); </span><br><span class="line">    Map&lt;String, Object&gt; sourceAsMap = result.sourceAsMap(); </span><br><span class="line">    <span class="keyword">byte</span>[] sourceAsBytes = result.source(); </span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以检查分片失败：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">ReplicationResponse.ShardInfo shardInfo = updateResponse.getShardInfo();</span><br><span class="line"><span class="keyword">if</span> (shardInfo.getTotal() != shardInfo.getSuccessful()) &#123;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (shardInfo.getFailed() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">for</span> (ReplicationResponse.ShardInfo.Failure failure : shardInfo.getFailures()) &#123;</span><br><span class="line">        String reason = failure.reason(); </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>当对一个不存在的文档执行<code>UpdateRequest</code>时，响应具有<code>404</code>状态代码，会抛出<code>ElasticsearchException</code>，需要按如下方式处理：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">UpdateRequest request = <span class="keyword">new</span> UpdateRequest(<span class="string">"posts"</span>, <span class="string">"type"</span>, <span class="string">"does_not_exist"</span>)</span><br><span class="line">        .doc(<span class="string">"field"</span>, <span class="string">"value"</span>);</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    UpdateResponse updateResponse = client.update(request);</span><br><span class="line">&#125; <span class="keyword">catch</span> (ElasticsearchException e) &#123;</span><br><span class="line">    <span class="keyword">if</span> (e.status() == RestStatus.NOT_FOUND) &#123;</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如果发生文档版本冲突，会抛出异常：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">UpdateRequest request = <span class="keyword">new</span> UpdateRequest(<span class="string">"posts"</span>, <span class="string">"doc"</span>, <span class="string">"1"</span>)</span><br><span class="line">        .doc(<span class="string">"field"</span>, <span class="string">"value"</span>)</span><br><span class="line">        .version(<span class="number">1</span>);</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    UpdateResponse updateResponse = client.update(request);</span><br><span class="line">&#125; <span class="keyword">catch</span>(ElasticsearchException e) &#123;</span><br><span class="line">    <span class="keyword">if</span> (e.status() == RestStatus.CONFLICT) &#123;   </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Bulk-API"><a href="#Bulk-API" class="headerlink" title="Bulk API"></a>Bulk API</h3><h4 id="BulkRequest"><a href="#BulkRequest" class="headerlink" title="BulkRequest"></a>BulkRequest</h4><p><code>BulkRequest</code>可用于使用单个请求执行多个索引，更新和/或删除操作</p>
<p>它要求至少将一个操作添加到批量请求：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">BulkRequest request = <span class="keyword">new</span> BulkRequest(); </span><br><span class="line">request.add(<span class="keyword">new</span> IndexRequest(<span class="string">"posts"</span>, <span class="string">"doc"</span>, <span class="string">"1"</span>)  </span><br><span class="line">        .source(XContentType.JSON,<span class="string">"field"</span>, <span class="string">"foo"</span>));</span><br><span class="line">request.add(<span class="keyword">new</span> IndexRequest(<span class="string">"posts"</span>, <span class="string">"doc"</span>, <span class="string">"2"</span>)  </span><br><span class="line">        .source(XContentType.JSON,<span class="string">"field"</span>, <span class="string">"bar"</span>));</span><br><span class="line">request.add(<span class="keyword">new</span> IndexRequest(<span class="string">"posts"</span>, <span class="string">"doc"</span>, <span class="string">"3"</span>)  </span><br><span class="line">        .source(XContentType.JSON,<span class="string">"field"</span>, <span class="string">"baz"</span>));</span><br></pre></td></tr></table></figure>
<p>并且可以添加不同的操作类型<code>BulkRequest</code>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">BulkRequest request = <span class="keyword">new</span> BulkRequest();</span><br><span class="line">request.add(<span class="keyword">new</span> DeleteRequest(<span class="string">"posts"</span>, <span class="string">"doc"</span>, <span class="string">"3"</span>)); </span><br><span class="line">request.add(<span class="keyword">new</span> UpdateRequest(<span class="string">"posts"</span>, <span class="string">"doc"</span>, <span class="string">"2"</span>) </span><br><span class="line">        .doc(XContentType.JSON,<span class="string">"other"</span>, <span class="string">"test"</span>));</span><br><span class="line">request.add(<span class="keyword">new</span> IndexRequest(<span class="string">"posts"</span>, <span class="string">"doc"</span>, <span class="string">"4"</span>)  </span><br><span class="line">        .source(XContentType.JSON,<span class="string">"field"</span>, <span class="string">"baz"</span>));</span><br></pre></td></tr></table></figure>
<h4 id="可选参数-4"><a href="#可选参数-4" class="headerlink" title="可选参数"></a>可选参数</h4><ul>
<li>设置超时时间</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">request.timeout(TimeValue.timeValueMinutes(<span class="number">2</span>)); </span><br><span class="line">request.timeout(<span class="string">"2m"</span>);</span><br></pre></td></tr></table></figure>
<ul>
<li>设置刷新策略</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">request.timeout(TimeValue.timeValueMinutes(<span class="number">2</span>)); </span><br><span class="line">request.timeout(<span class="string">"2m"</span>);</span><br></pre></td></tr></table></figure>
<ul>
<li>设置在索引/更新/删除操作之前必须处于活动状态的分片副本数</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">request.waitForActiveShards(<span class="number">2</span>); </span><br><span class="line">request.waitForActiveShards(ActiveShardCount.ALL); <span class="comment">//可选ActiveShardCount.ALL、 ActiveShardCount.ONE 、 ActiveShardCount.DEFAULT</span></span><br></pre></td></tr></table></figure>
<h4 id="同步执行-4"><a href="#同步执行-4" class="headerlink" title="同步执行"></a>同步执行</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">BulkResponse bulkResponse = client.bulk(request);</span><br></pre></td></tr></table></figure>
<h4 id="异步执行-4"><a href="#异步执行-4" class="headerlink" title="异步执行"></a>异步执行</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">ActionListener&lt;BulkResponse&gt; listener = <span class="keyword">new</span> ActionListener&lt;BulkResponse&gt;() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onResponse</span><span class="params">(BulkResponse bulkResponse)</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onFailure</span><span class="params">(Exception e)</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line">client.bulkAsync(request, listener);</span><br></pre></td></tr></table></figure>
<h4 id="BulkResponse"><a href="#BulkResponse" class="headerlink" title="BulkResponse"></a>BulkResponse</h4><p>响应结果，允许迭代每个结果，如下所示：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (BulkItemResponse bulkItemResponse : bulkResponse) &#123; </span><br><span class="line">    <span class="comment">//可以是IndexResponse、UpdateResponse、DeleteResponse，他们可以全部被视为DocWriteResponse实例</span></span><br><span class="line">    DocWriteResponse itemResponse = bulkItemResponse.getResponse(); </span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (bulkItemResponse.getOpType() == DocWriteRequest.OpType.INDEX</span><br><span class="line">            || bulkItemResponse.getOpType() == DocWriteRequest.OpType.CREATE) &#123; </span><br><span class="line">        IndexResponse indexResponse = (IndexResponse) itemResponse;</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (bulkItemResponse.getOpType() == DocWriteRequest.OpType.UPDATE) &#123; </span><br><span class="line">        UpdateResponse updateResponse = (UpdateResponse) itemResponse;</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (bulkItemResponse.getOpType() == DocWriteRequest.OpType.DELETE) &#123; </span><br><span class="line">        DeleteResponse deleteResponse = (DeleteResponse) itemResponse;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>批量响应提供了一种快速检查一个或多个操作是否失败的方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>（bulkResponse.hasFailures（））&#123; </span><br><span class="line"><span class="comment">//如果至少有一个操作失败，则返回true</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在这种情况下，有必要迭代所有操作结果，以检查操作是否失败，如果是，则获取相应的失败信息： </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span>（BulkItemResponse bulkItemResponse：bulkResponse）&#123;</span><br><span class="line">    <span class="keyword">if</span>（bulkItemResponse.isFailed（））&#123; </span><br><span class="line">        BulkItemResponse.Failure failure = bulkItemResponse.getFailure（）; </span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="批量处理器"><a href="#批量处理器" class="headerlink" title="批量处理器"></a>批量处理器</h4><p><code>BulkProcessor</code>提供了一个工具类简化操作，它可以透明地执行添加到 <code>processor</code> 中的 <code>index</code>/<code>update</code>/<code>delete</code>操作。</p>
<p>为了执行请求，<code>BulkProcessor</code>需要以下组件：</p>
<ul>
<li><p><code>RestHighLevelClient</code></p>
<p>此客户端用于执行<code>BulkRequest</code> 和获取<code>BulkResponse</code></p>
</li>
<li><p><code>BulkProcessor.Listener</code></p>
<p>在每次<code>BulkRequest</code>执行之前、之后或<code>BulkRequest</code>失败时调用器监听</p>
</li>
</ul>
<p>然后该<code>BulkProcessor.builder</code>方法可用于构建新的<code>BulkProcessor</code>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">BulkProcessor.Listener listener = <span class="keyword">new</span> BulkProcessor.Listener() &#123; </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">beforeBulk</span><span class="params">(<span class="keyword">long</span> executionId, BulkRequest request)</span> </span>&#123;</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">afterBulk</span><span class="params">(<span class="keyword">long</span> executionId, BulkRequest request,</span></span></span><br><span class="line"><span class="function"><span class="params">            BulkResponse response)</span> </span>&#123;</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">afterBulk</span><span class="params">(<span class="keyword">long</span> executionId, BulkRequest request, Throwable failure)</span> </span>&#123;</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">BulkProcessor bulkProcessor =</span><br><span class="line">        BulkProcessor.builder(client::bulkAsync, listener).build();</span><br></pre></td></tr></table></figure>
<p><code>BulkProcessor.Builder</code>提供了方法来配置<code>BulkProcessor</code>处理请求的行为：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">BulkProcessor.Builder builder = BulkProcessor.builder(client::bulkAsync, listener);</span><br><span class="line">builder.setBulkActions(<span class="number">500</span>);<span class="comment">//根据当前添加的操作数设置何时刷新新的批量请求（默认为1000，使用-1禁用它） </span></span><br><span class="line">builder.setBulkSize(<span class="keyword">new</span> ByteSizeValue(<span class="number">1L</span>, ByteSizeUnit.MB)); <span class="comment">//根据当前添加的操作内容大小设置何时刷新新的批量请求（默认为5Mb，使用-1禁用它）</span></span><br><span class="line">builder.setConcurrentRequests(<span class="number">0</span>); <span class="comment">//设置允许执行的并发请求数（默认为1，使用0只允许执行单个请求）</span></span><br><span class="line">builder.setFlushInterval(TimeValue.timeValueSeconds(<span class="number">10L</span>)); <span class="comment">//BulkRequest如果间隔超过，则 设置刷新间隔刷新任何挂起（默认为未设置）</span></span><br><span class="line">builder.setBackoffPolicy(BackoffPolicy</span><br><span class="line">        .constantBackoff(TimeValue.timeValueSeconds(<span class="number">1L</span>), <span class="number">3</span>));<span class="comment">//设置一个最初等待1秒的常量重试策略，最多重试3次。见BackoffPolicy.noBackoff()、BackoffPolicy.constantBackoff()、BackoffPolicy.exponentialBackoff() 提供更多的选择</span></span><br></pre></td></tr></table></figure>
<p>一旦<code>BulkProcessor</code>被创建，请求可以被添加到<code>processor</code>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">IndexRequest one = <span class="keyword">new</span> IndexRequest(<span class="string">"posts"</span>, <span class="string">"doc"</span>, <span class="string">"1"</span>).</span><br><span class="line">        source(XContentType.JSON, <span class="string">"title"</span>,</span><br><span class="line">                <span class="string">"In which order are my Elasticsearch queries executed?"</span>);</span><br><span class="line">IndexRequest two = <span class="keyword">new</span> IndexRequest(<span class="string">"posts"</span>, <span class="string">"doc"</span>, <span class="string">"2"</span>)</span><br><span class="line">        .source(XContentType.JSON, <span class="string">"title"</span>,</span><br><span class="line">                <span class="string">"Current status and upcoming changes in Elasticsearch"</span>);</span><br><span class="line">IndexRequest three = <span class="keyword">new</span> IndexRequest(<span class="string">"posts"</span>, <span class="string">"doc"</span>, <span class="string">"3"</span>)</span><br><span class="line">        .source(XContentType.JSON, <span class="string">"title"</span>,</span><br><span class="line">                <span class="string">"The Future of Federated Search in Elasticsearch"</span>);</span><br><span class="line"></span><br><span class="line">bulkProcessor.add(one);</span><br><span class="line">bulkProcessor.add(two);</span><br><span class="line">bulkProcessor.add(three);</span><br></pre></td></tr></table></figure>
<p><code>BulkProcessor</code> 执行所有的请求，并且为每次的 <code>BulkRequest</code> 回调<code>BulkProcessor.Listener</code>，监听器提供了访问 <code>BulkRequest</code> 和 <code>BulkResponse</code> 的方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">BulkProcessor.Listener listener = <span class="keyword">new</span> BulkProcessor.Listener() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">beforeBulk</span><span class="params">(<span class="keyword">long</span> executionId, BulkRequest request)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> numberOfActions = request.numberOfActions(); </span><br><span class="line">        logger.debug(<span class="string">"Executing bulk [&#123;&#125;] with &#123;&#125; requests"</span>,</span><br><span class="line">                executionId, numberOfActions);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">afterBulk</span><span class="params">(<span class="keyword">long</span> executionId, BulkRequest request,</span></span></span><br><span class="line"><span class="function"><span class="params">            BulkResponse response)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (response.hasFailures()) &#123; </span><br><span class="line">            logger.warn(<span class="string">"Bulk [&#123;&#125;] executed with failures"</span>, executionId);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            logger.debug(<span class="string">"Bulk [&#123;&#125;] completed in &#123;&#125; milliseconds"</span>,</span><br><span class="line">                    executionId, response.getTook().getMillis());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">afterBulk</span><span class="params">(<span class="keyword">long</span> executionId, BulkRequest request, Throwable failure)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//执行失败后调用</span></span><br><span class="line">        logger.error(<span class="string">"Failed to execute bulk"</span>, failure); </span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>将所有请求添加到<code>BulkProcessor</code>后，需要关闭其实例，有两种关闭方式。</p>
<p>该<code>awaitClose()</code>方法可用于等待所有请求都已处理或指定的等待时间：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">boolean</span> terminated = bulkProcessor.awaitClose（<span class="number">30L</span>，TimeUnit.SECONDS）;<span class="comment">//true：如果所有批量请求都已完成，false：在所有批量请求完成之前等待时间已过</span></span><br></pre></td></tr></table></figure>
<p><code>close()</code>方法可用于立即关闭<code>BulkProcessor</code>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bulkProcessor.close（）;</span><br></pre></td></tr></table></figure>
<p>两种方法在关闭处理器之前刷新已经添加到处理器的请求，并且禁止添加新请求</p>
<h3 id="Multi-Get-API"><a href="#Multi-Get-API" class="headerlink" title="Multi-Get API"></a>Multi-Get API</h3><p><code>multiGet API</code> 可以在单个请求中执行多个 <code>get</code> 请求</p>
<h4 id="Multi-Get-Request"><a href="#Multi-Get-Request" class="headerlink" title="Multi-Get Request"></a>Multi-Get Request</h4><p>获取一个 <code>MultiGetRequest</code>实例，然后添加多个 <code>MultiGetRequest.Item</code>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">MultiGetRequest request = <span class="keyword">new</span> MultiGetRequest();</span><br><span class="line">request.add(<span class="keyword">new</span> MultiGetRequest.Item(</span><br><span class="line">    <span class="string">"index"</span>,         </span><br><span class="line">    <span class="string">"type"</span>,          </span><br><span class="line">    <span class="string">"example_id"</span>));  </span><br><span class="line">request.add(<span class="keyword">new</span> MultiGetRequest.Item(<span class="string">"index"</span>, <span class="string">"type"</span>, <span class="string">"another_id"</span>));</span><br></pre></td></tr></table></figure>
<h4 id="可选参数-5"><a href="#可选参数-5" class="headerlink" title="可选参数"></a>可选参数</h4><p><code>multiGet</code>和 <code>get Api</code>支持相同的可选参数. 你可以在 <code>Item</code>上设置可选参数:</p>
<ul>
<li>设置不返回任何文档，默认返回文档</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">request.add(<span class="keyword">new</span> MultiGetRequest.Item(<span class="string">"index"</span>, <span class="string">"type"</span>, <span class="string">"example_id"</span>)</span><br><span class="line">            .fetchSourceContext(FetchSourceContext.DO_NOT_FETCH_SOURCE)</span><br><span class="line">    );</span><br></pre></td></tr></table></figure>
<ul>
<li>设置返回文档的哪些字段</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">String[] includes = <span class="keyword">new</span> String[] &#123;<span class="string">"foo"</span>, <span class="string">"*r"</span>&#125;;</span><br><span class="line">String[] excludes = Strings.EMPTY_ARRAY;</span><br><span class="line">FetchSourceContext fetchSourceContext =</span><br><span class="line">        <span class="keyword">new</span> FetchSourceContext(<span class="keyword">true</span>, includes, excludes);</span><br><span class="line">request.add(<span class="keyword">new</span> MultiGetRequest.Item(<span class="string">"index"</span>, <span class="string">"type"</span>, <span class="string">"example_id"</span>)</span><br><span class="line">    .fetchSourceContext(fetchSourceContext));</span><br></pre></td></tr></table></figure>
<ul>
<li>设置不返回文档的哪些字段</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">String[] includes = Strings.EMPTY_ARRAY;</span><br><span class="line">String[] excludes = <span class="keyword">new</span> String[] &#123;<span class="string">"foo"</span>, <span class="string">"*r"</span>&#125;;</span><br><span class="line">FetchSourceContext fetchSourceContext =</span><br><span class="line">        <span class="keyword">new</span> FetchSourceContext(<span class="keyword">true</span>, includes, excludes);</span><br><span class="line">request.add(<span class="keyword">new</span> MultiGetRequest.Item(<span class="string">"index"</span>, <span class="string">"type"</span>, <span class="string">"example_id"</span>)</span><br><span class="line">    .fetchSourceContext(fetchSourceContext));</span><br></pre></td></tr></table></figure>
<ul>
<li>配置返回指定的存储字段</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">request.add(<span class="keyword">new</span> MultiGetRequest.Item(<span class="string">"index"</span>, <span class="string">"type"</span>, <span class="string">"example_id"</span>)</span><br><span class="line">    .storedFields(<span class="string">"foo"</span>));  <span class="comment">//设置返回存储字段 foo</span></span><br><span class="line">MultiGetResponse response = client.multiGet(request);</span><br><span class="line">MultiGetItemResponse item = response.getResponses()[<span class="number">0</span>];</span><br><span class="line">String value = item.getResponse().getField(<span class="string">"foo"</span>).getValue(); <span class="comment">//获取存储字段foo的值</span></span><br></pre></td></tr></table></figure>
<ul>
<li>其他可选参数</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">request.add(<span class="keyword">new</span> MultiGetRequest.Item(<span class="string">"index"</span>, <span class="string">"type"</span>, <span class="string">"with_routing"</span>)</span><br><span class="line">    .routing(<span class="string">"some_routing"</span>));<span class="comment">//设置路由       </span></span><br><span class="line">request.add(<span class="keyword">new</span> MultiGetRequest.Item(<span class="string">"index"</span>, <span class="string">"type"</span>, <span class="string">"with_parent"</span>)</span><br><span class="line">    .parent(<span class="string">"some_parent"</span>));<span class="comment">//设置父文档       </span></span><br><span class="line">request.add(<span class="keyword">new</span> MultiGetRequest.Item(<span class="string">"index"</span>, <span class="string">"type"</span>, <span class="string">"with_version"</span>)</span><br><span class="line">    .versionType(VersionType.EXTERNAL)<span class="comment">//设置文档版本类型</span></span><br><span class="line">    .version(<span class="number">10123L</span>)); <span class="comment">//设置版本号</span></span><br><span class="line">request.preference(<span class="string">"some_preference"</span>);  <span class="comment">//设置偏好</span></span><br><span class="line">request.realtime(<span class="keyword">false</span>); <span class="comment">//设置实时标识，默认为 true       </span></span><br><span class="line">request.refresh(<span class="keyword">true</span>); <span class="comment">//获取文档之前执行刷新操作，默认 false</span></span><br></pre></td></tr></table></figure>
<h4 id="同步执行-5"><a href="#同步执行-5" class="headerlink" title="同步执行"></a>同步执行</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">MultiGetResponse response = client.multiGet(request);</span><br></pre></td></tr></table></figure>
<h4 id="异步执行-5"><a href="#异步执行-5" class="headerlink" title="异步执行"></a>异步执行</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">ActionListener&lt;MultiGetResponse&gt; listener = <span class="keyword">new</span> ActionListener&lt;MultiGetResponse&gt;() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onResponse</span><span class="params">(MultiGetResponse response)</span> </span>&#123;</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onFailure</span><span class="params">(Exception e)</span> </span>&#123;</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line">MultiGetResponse response = client.multiGet(request);</span><br></pre></td></tr></table></figure>
<h4 id="MultiGetResponse"><a href="#MultiGetResponse" class="headerlink" title="MultiGetResponse"></a>MultiGetResponse</h4><p>返回的<code>MultiGetResponse</code>通过<code>getResponses</code>方法可以获取一个 <code>MultiGetItemResponse</code> 列表，列表中的响应与请求的顺序相同，如果 <code>get</code> 成功 <code>MultiGetItemResponse</code>包含一个 <code>GetResponse</code>，如果它失败了会包含一个<code>MultiGetResponse.Failure</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">MultiGetItemResponse firstItem = response.getResponses（）[<span class="number">0</span>];</span><br><span class="line">assertNull（firstItem.getFailure（））;<span class="comment">//如果成功，返回 null       </span></span><br><span class="line">GetResponse firstGet = firstItem.getResponse（）; <span class="comment">//获取 GetResponse</span></span><br><span class="line">String index = firstItem.getIndex（）;</span><br><span class="line">String type = firstItem.getType（）;</span><br><span class="line">String id = firstItem.getId（）;</span><br><span class="line"><span class="keyword">if</span>（firstGet.isExists（））<span class="comment">//判断文档是否存在</span></span><br><span class="line">    <span class="keyword">long</span> version = firstGet.getVersion（）;</span><br><span class="line">    String sourceAsString = firstGet.getSourceAsString（）;        </span><br><span class="line">    Map &lt;String，Object&gt; sourceAsMap = firstGet.getSourceAsMap（）; </span><br><span class="line">    <span class="keyword">byte</span> [] sourceAsBytes = firstGet.getSourceAsBytes（）;          </span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如果请求的 index 不存在，则返回响应会包含一个异常信息</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">assertNull(missingIndexItem.getResponse());                </span><br><span class="line">Exception e = missingIndexItem.getFailure().getFailure();  </span><br><span class="line">ElasticsearchException ee = (ElasticsearchException) e;    </span><br><span class="line"><span class="comment">// TODO status is broken! fix in a followup</span></span><br><span class="line"><span class="comment">// assertEquals(RestStatus.NOT_FOUND, ee.status());        </span></span><br><span class="line">assertThat(e.getMessage(),</span><br><span class="line">    containsString(<span class="string">"reason=no such index"</span>));</span><br></pre></td></tr></table></figure>
<p>请求文档版本冲突，则返回响应会包含一个异常信息</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">MultiGetRequest request = <span class="keyword">new</span> MultiGetRequest();</span><br><span class="line">request.add(<span class="keyword">new</span> MultiGetRequest.Item(<span class="string">"index"</span>, <span class="string">"type"</span>, <span class="string">"example_id"</span>)</span><br><span class="line">    .version(<span class="number">1000L</span>));</span><br><span class="line">MultiGetResponse response = client.multiGet(request);</span><br><span class="line">MultiGetItemResponse item = response.getResponses()[<span class="number">0</span>];</span><br><span class="line">assertNull(item.getResponse());                          </span><br><span class="line">Exception e = item.getFailure().getFailure();            </span><br><span class="line">ElasticsearchException ee = (ElasticsearchException) e;  </span><br><span class="line"><span class="comment">// TODO status is broken! fix in a followup</span></span><br><span class="line"><span class="comment">// assertEquals(RestStatus.CONFLICT, ee.status());          </span></span><br><span class="line">assertThat(e.getMessage(),</span><br><span class="line">    containsString(<span class="string">"version conflict, current version [1] is "</span></span><br><span class="line">        + <span class="string">"different than the one provided [1000]"</span>));</span><br></pre></td></tr></table></figure>
<h2 id="Search-API"><a href="#Search-API" class="headerlink" title="Search API"></a>Search API</h2><p>高级客户端支持下面的 <code>Search API</code>:</p>
<ul>
<li>Search API</li>
<li>Search Scroll API</li>
<li>Clear Scroll API</li>
<li>Multi-Search API</li>
<li>Ranking Evaluation API</li>
</ul>
<h3 id="Search-API-1"><a href="#Search-API-1" class="headerlink" title="Search API"></a>Search API</h3><h4 id="SearchRequest"><a href="#SearchRequest" class="headerlink" title="SearchRequest"></a>SearchRequest</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">SearchRequest searchRequest = <span class="keyword">new</span> SearchRequest(); </span><br><span class="line">SearchSourceBuilder searchSourceBuilder = <span class="keyword">new</span> SearchSourceBuilder(); </span><br><span class="line">searchSourceBuilder.query(QueryBuilders.matchAllQuery()); </span><br><span class="line">searchRequest.source(searchSourceBuilder);</span><br></pre></td></tr></table></figure>
<h4 id="可选参数-6"><a href="#可选参数-6" class="headerlink" title="可选参数"></a>可选参数</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">SearchRequest searchRequest = <span class="keyword">new</span> SearchRequest(<span class="string">"posts"</span>); </span><br><span class="line">searchRequest.types(<span class="string">"doc"</span>); </span><br><span class="line">searchRequest.routing(<span class="string">"routing"</span>); </span><br><span class="line">searchRequest.indicesOptions(IndicesOptions.lenientExpandOpen());</span><br><span class="line">searchRequest.preference(<span class="string">"_local"</span>);</span><br></pre></td></tr></table></figure>
<h4 id="使用-SearchBuilder"><a href="#使用-SearchBuilder" class="headerlink" title="使用 SearchBuilder"></a>使用 SearchBuilder</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">SearchSourceBuilder sourceBuilder = <span class="keyword">new</span> SearchSourceBuilder(); </span><br><span class="line">sourceBuilder.query(QueryBuilders.termQuery(<span class="string">"user"</span>, <span class="string">"kimchy"</span>)); </span><br><span class="line">sourceBuilder.from(<span class="number">0</span>); </span><br><span class="line">sourceBuilder.size(<span class="number">5</span>); </span><br><span class="line">sourceBuilder.timeout(<span class="keyword">new</span> TimeValue(<span class="number">60</span>, TimeUnit.SECONDS));</span><br></pre></td></tr></table></figure>
<h4 id="构建查询语句"><a href="#构建查询语句" class="headerlink" title="构建查询语句"></a>构建查询语句</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">MatchQueryBuilder matchQueryBuilder = <span class="keyword">new</span> MatchQueryBuilder(<span class="string">"user"</span>, <span class="string">"kimchy"</span>);</span><br><span class="line">matchQueryBuilder.fuzziness(Fuzziness.AUTO); </span><br><span class="line">matchQueryBuilder.prefixLength(<span class="number">3</span>); </span><br><span class="line">matchQueryBuilder.maxExpansions(<span class="number">10</span>); </span><br><span class="line">matchQueryBuilder.fuzziness(Fuzziness.AUTO); </span><br><span class="line">matchQueryBuilder.prefixLength(<span class="number">3</span>); </span><br><span class="line">matchQueryBuilder.maxExpansions(<span class="number">10</span>); </span><br><span class="line">searchSourceBuilder.query(matchQueryBuilder);</span><br></pre></td></tr></table></figure>
<h4 id="设置排序"><a href="#设置排序" class="headerlink" title="设置排序"></a>设置排序</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sourceBuilder.sort(<span class="keyword">new</span> ScoreSortBuilder().order(SortOrder.DESC)); </span><br><span class="line">sourceBuilder.sort(<span class="keyword">new</span> FieldSortBuilder(<span class="string">"_uid"</span>).order(SortOrder.ASC));</span><br></pre></td></tr></table></figure>
<h4 id="文档过滤"><a href="#文档过滤" class="headerlink" title="文档过滤"></a>文档过滤</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sourceBuilder.fetchSource(<span class="keyword">false</span>);</span><br><span class="line">String[] includeFields = <span class="keyword">new</span> String[] &#123;<span class="string">"title"</span>, <span class="string">"user"</span>, <span class="string">"innerObject.*"</span>&#125;;</span><br><span class="line">String[] excludeFields = <span class="keyword">new</span> String[] &#123;<span class="string">"_type"</span>&#125;;</span><br><span class="line">sourceBuilder.fetchSource(includeFields, excludeFields);</span><br></pre></td></tr></table></figure>
<h4 id="字段高亮"><a href="#字段高亮" class="headerlink" title="字段高亮"></a>字段高亮</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">SearchSourceBuilder searchSourceBuilder = <span class="keyword">new</span> SearchSourceBuilder();</span><br><span class="line">HighlightBuilder highlightBuilder = <span class="keyword">new</span> HighlightBuilder(); </span><br><span class="line">HighlightBuilder.Field highlightTitle =</span><br><span class="line">        <span class="keyword">new</span> HighlightBuilder.Field(<span class="string">"title"</span>); </span><br><span class="line">highlightTitle.highlighterType(<span class="string">"unified"</span>);  </span><br><span class="line">highlightBuilder.field(highlightTitle);  </span><br><span class="line">HighlightBuilder.Field highlightUser = <span class="keyword">new</span> HighlightBuilder.Field(<span class="string">"user"</span>);</span><br><span class="line">highlightBuilder.field(highlightUser);</span><br><span class="line">searchSourceBuilder.highlighter(highlightBuilder);</span><br></pre></td></tr></table></figure>
<h4 id="添加聚合查询"><a href="#添加聚合查询" class="headerlink" title="添加聚合查询"></a>添加聚合查询</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">SearchSourceBuilder searchSourceBuilder = <span class="keyword">new</span> SearchSourceBuilder();</span><br><span class="line">TermsAggregationBuilder aggregation = AggregationBuilders.terms(<span class="string">"by_company"</span>)</span><br><span class="line">        .field(<span class="string">"company.keyword"</span>);</span><br><span class="line">aggregation.subAggregation(AggregationBuilders.avg(<span class="string">"average_age"</span>)</span><br><span class="line">        .field(<span class="string">"age"</span>));</span><br><span class="line">searchSourceBuilder.aggregation(aggregation);</span><br></pre></td></tr></table></figure>
<h4 id="请求建议词"><a href="#请求建议词" class="headerlink" title="请求建议词"></a>请求建议词</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">SearchSourceBuilder searchSourceBuilder = <span class="keyword">new</span> SearchSourceBuilder();</span><br><span class="line">SuggestionBuilder termSuggestionBuilder =</span><br><span class="line">    SuggestBuilders.termSuggestion(<span class="string">"user"</span>).text(<span class="string">"kmichy"</span>); </span><br><span class="line">SuggestBuilder suggestBuilder = <span class="keyword">new</span> SuggestBuilder();</span><br><span class="line">suggestBuilder.addSuggestion(<span class="string">"suggest_user"</span>, termSuggestionBuilder); </span><br><span class="line">searchSourceBuilder.suggest(suggestBuilder);</span><br></pre></td></tr></table></figure>
<h4 id="分析查询和聚合"><a href="#分析查询和聚合" class="headerlink" title="分析查询和聚合"></a>分析查询和聚合</h4><p><code>profile API</code> 可用于为特定搜索分析查询和聚合的执行情况。为了使用它, 必须在 SearchSourceBuilder 上设置<code>profile</code>标志为 <code>true</code>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">SearchSourceBuilder searchSourceBuilder = <span class="keyword">new</span> SearchSourceBuilder();</span><br><span class="line">searchSourceBuilder.profile(<span class="keyword">true</span>);</span><br></pre></td></tr></table></figure>
<p>执行 <code>SearchRequest</code> 后, 相应的 <code>SearchResponse</code> 将包含分析结果。</p>
<h4 id="同步执行-6"><a href="#同步执行-6" class="headerlink" title="同步执行"></a>同步执行</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SearchResponse searchResponse = client.search(searchRequest);</span><br></pre></td></tr></table></figure>
<h4 id="异步执行-6"><a href="#异步执行-6" class="headerlink" title="异步执行"></a>异步执行</h4><p>执行 <code>SearchRequest</code> 也可以以异步方式进行, 以便客户端可以直接返回。用户需要通过将请求和监听器传递给异步搜索方法来指定如何处理响应或潜在故障:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">ActionListener&lt;SearchResponse&gt; listener = <span class="keyword">new</span> ActionListener&lt;SearchResponse&gt;() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onResponse</span><span class="params">(SearchResponse searchResponse)</span> </span>&#123;</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onFailure</span><span class="params">(Exception e)</span> </span>&#123;</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line">client.searchAsync(searchRequest, listener);</span><br></pre></td></tr></table></figure>
<p>异步方法不会阻止线程，也不会立即返回。完成该操作后, 如果执行成功则回调<code>ActionListener</code>的 <code>onResponse</code> 方法，失败则回调 onFailure` 方法</p>
<h4 id="SearchResponse"><a href="#SearchResponse" class="headerlink" title="SearchResponse"></a>SearchResponse</h4><p>执行搜索返回的 <code>SearchResponse</code> 提供了有关搜索执行本身以及对返回访问的文档的详细信息。看下有关于请求执行操作的信息, 如 HTTP 状态代码、执行时间或请求是否提前终止或超时:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">RestStatus status = searchResponse.status();</span><br><span class="line">TimeValue took = searchResponse.getTook();</span><br><span class="line">Boolean terminatedEarly = searchResponse.isTerminatedEarly();</span><br><span class="line"><span class="keyword">boolean</span> timedOut = searchResponse.isTimedOut();</span><br></pre></td></tr></table></figure>
<p>其次, 响应还提供有关在分片级别上执行的信息, 提供有关受影响搜索的分片总数以及成功与失败的分片的统计数据。潜在的故障也可以通过迭代 <code>ShardSearchFailure</code> 数组来处理, 如下面的示例所示:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> totalShards = searchResponse.getTotalShards();</span><br><span class="line"><span class="keyword">int</span> successfulShards = searchResponse.getSuccessfulShards();</span><br><span class="line"><span class="keyword">int</span> failedShards = searchResponse.getFailedShards();</span><br><span class="line"><span class="keyword">for</span> (ShardSearchFailure failure : searchResponse.getShardFailures()) &#123;</span><br><span class="line">    <span class="comment">// failures should be handled here</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="获取搜索命中的文档"><a href="#获取搜索命中的文档" class="headerlink" title="获取搜索命中的文档"></a>获取搜索命中的文档</h4><p>要获得对返回的文档的访问权限, 我们首先需要得到响应中包含的 SearchHits：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">SearchHits hits = searchResponse.getHits();</span><br><span class="line"><span class="keyword">long</span> totalHits = hits.getTotalHits();</span><br><span class="line"><span class="keyword">float</span> maxScore = hits.getMaxScore();</span><br></pre></td></tr></table></figure>
<p>SearchHits 提供有关所有命中的全局信息, 如命中总数或最大得分:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">long</span> totalHits = hits.getTotalHits();</span><br><span class="line"><span class="keyword">float</span> maxScore = hits.getMaxScore();</span><br></pre></td></tr></table></figure>
<p>嵌套在 SearchHits 中的是可以迭代的单个搜索结果:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">SearchHit[] searchHits = hits.getHits();</span><br><span class="line"><span class="keyword">for</span> (SearchHit hit : searchHits) &#123;</span><br><span class="line">    <span class="comment">// do something with the SearchHit</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>SearchHit 提供对基本信息的访问, 如索引、类型、docId 和每个搜索命中的分数:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">String index = hit.getIndex();</span><br><span class="line">String type = hit.getType();</span><br><span class="line">String id = hit.getId();</span><br><span class="line"><span class="keyword">float</span> score = hit.getScore();</span><br></pre></td></tr></table></figure>
<p>此外, 它还允许您返回文档源, 既可以是简单的 JSON 字符串, 也可以是键/值对的映射。在此映射中,通常键值对的键为字段名, 值为字段值。多值字段作为对象的列表返回, 嵌套对象作为另一个键/值映射。这些案件需要相应地强制执行:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">String sourceAsString = hit.getSourceAsString();</span><br><span class="line">Map&lt;String, Object&gt; sourceAsMap = hit.getSourceAsMap();</span><br><span class="line">String documentTitle = (String) sourceAsMap.get(<span class="string">"title"</span>);</span><br><span class="line">List&lt;Object&gt; users = (List&lt;Object&gt;) sourceAsMap.get(<span class="string">"user"</span>);</span><br><span class="line">Map&lt;String, Object&gt; innerObject =</span><br><span class="line">        (Map&lt;String, Object&gt;) sourceAsMap.get(<span class="string">"innerObject"</span>);</span><br></pre></td></tr></table></figure>
<h4 id="获取高亮结果"><a href="#获取高亮结果" class="headerlink" title="获取高亮结果"></a>获取高亮结果</h4><p>可以从结果中获取每个 <code>SearchHit</code> 中高亮显示的文本片段。<code>SearchHit</code>提供对 <code>HighlightField</code> 实例的访问, 其中每一个都包含一个或多个突出显示的文本片段:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">SearchHits hits = searchResponse.getHits();</span><br><span class="line"><span class="keyword">for</span> (SearchHit hit : hits.getHits()) &#123;</span><br><span class="line">    Map&lt;String, HighlightField&gt; highlightFields = hit.getHighlightFields();</span><br><span class="line">    HighlightField highlight = highlightFields.get(<span class="string">"title"</span>); </span><br><span class="line">    Text[] fragments = highlight.fragments();  </span><br><span class="line">    String fragmentString = fragments[<span class="number">0</span>].string();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="获取聚合结果"><a href="#获取聚合结果" class="headerlink" title="获取聚合结果"></a>获取聚合结果</h4><p>可以从 SearchResponse 获取聚合结果, 首先获取聚合树的根、聚合对象, 然后按名称获取聚合</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Aggregations aggregations = searchResponse.getAggregations();</span><br><span class="line">Terms byCompanyAggregation = aggregations.get(<span class="string">"by_company"</span>); </span><br><span class="line">Bucket elasticBucket = byCompanyAggregation.getBucketByKey(<span class="string">"Elastic"</span>); </span><br><span class="line">Avg averageAge = elasticBucket.getAggregations().get(<span class="string">"average_age"</span>); </span><br><span class="line"><span class="keyword">double</span> avg = averageAge.getValue();</span><br></pre></td></tr></table></figure>
<p>请注意, 如果按名称访问聚合, 则需要根据所请求的聚合类型指定聚合接口, 否则将引发抛出:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Range range = aggregations.get(<span class="string">"by_company"</span>); <span class="comment">//这将引发异常, 因为 "by_company" 是一个term聚合, 但这里尝试将它一范围聚合取出</span></span><br></pre></td></tr></table></figure>
<p>还可以将所有的聚合 转化成 <code>map</code> ,以聚合名作为 <code>key</code> 值。在这种情况下,需要显示强制转换到正确的类型:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Map&lt;String, Aggregation&gt; aggregationMap = aggregations.getAsMap();</span><br><span class="line">Terms companyAggregation = (Terms) aggregationMap.get(<span class="string">"by_company"</span>);</span><br></pre></td></tr></table></figure>
<p>还有一些 getter 将所有顶层聚合作为列表返回:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">List&lt;Aggregation&gt; aggregationList = aggregations.asList();</span><br></pre></td></tr></table></figure>
<p>最后, 可以遍历所有聚合, 然后根据它们的类型决定如何进一步处理它们:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (Aggregation agg : aggregations) &#123;</span><br><span class="line">    String type = agg.getType();</span><br><span class="line">    <span class="keyword">if</span> (type.equals(TermsAggregationBuilder.NAME)) &#123;</span><br><span class="line">        Bucket elasticBucket = ((Terms) agg).getBucketByKey(<span class="string">"Elastic"</span>);</span><br><span class="line">        <span class="keyword">long</span> numberOfDocs = elasticBucket.getDocCount();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="获取建议"><a href="#获取建议" class="headerlink" title="获取建议"></a>获取建议</h4><p>要从 SearchResponse 中返回<code>suggestions</code>, 请使用<code>suggestion</code> 对象作为入口点, 然后检索嵌套的建议对象:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Suggest suggest = searchResponse.getSuggest(); </span><br><span class="line">TermSuggestion termSuggestion = suggest.getSuggestion(<span class="string">"suggest_user"</span>); </span><br><span class="line"><span class="keyword">for</span> (TermSuggestion.Entry entry : termSuggestion.getEntries()) &#123; </span><br><span class="line">    <span class="keyword">for</span> (TermSuggestion.Entry.Option option : entry) &#123; </span><br><span class="line">        String suggestText = option.getText().string();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="获取性能分析结果"><a href="#获取性能分析结果" class="headerlink" title="获取性能分析结果"></a>获取性能分析结果</h4><p>使用 <code>getProfileResults ()</code> 方法从 <code>SearchResponse</code> 检索性能分析结果。此方法返回一个<code>Map</code>,包含 <code>SearchRequest</code> 执行中所涉及的每个分片的 <code>ProfileShardResult</code> 对象。<code>ProfileShardResult</code> 存储在映射中, 使用唯一标识配置文件结果对应的碎片的键.   </p>
<p>下面是一个示例代码, 它演示如何循环访问每个分片的所有性能分析结果:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Map&lt;String, ProfileShardResult&gt; profilingResults =</span><br><span class="line">        searchResponse.getProfileResults(); </span><br><span class="line"><span class="keyword">for</span> (Map.Entry&lt;String, ProfileShardResult&gt; profilingResult : profilingResults.entrySet()) &#123; </span><br><span class="line">    String key = profilingResult.getKey(); </span><br><span class="line">    ProfileShardResult profileShardResult = profilingResult.getValue(); </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>ProfileShardResult</code> 对象本身包含一个或多个<code>QueryProfileShardResult</code>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">List&lt;QueryProfileShardResult&gt; queryProfileShardResults =</span><br><span class="line">        profileShardResult.getQueryProfileResults(); </span><br><span class="line"><span class="keyword">for</span> (QueryProfileShardResult queryProfileResult : queryProfileShardResults) &#123; </span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (ProfileResult profileResult : queryProfileResult.getQueryResults()) &#123; </span><br><span class="line">    String queryName = profileResult.getQueryName(); </span><br><span class="line">    <span class="keyword">long</span> queryTimeInMillis = profileResult.getTime(); </span><br><span class="line">    List&lt;ProfileResult&gt; profiledChildren = profileResult.getProfiledChildren(); </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
      
    </div>
    <div class="article-footer">
      <blockquote class="mt-2x">
  <ul class="post-copyright list-unstyled">
    
    <li class="post-copyright-link hidden-xs">
      <strong>本文链接：</strong>
      <a href="https://blog.milk4j.com/2018/06/20/ElasticSearch-Rest-客户端使用/" title="ElasticSearch Rest 客户端使用(长文,待续...)" target="_blank" rel="external">https://blog.milk4j.com/2018/06/20/ElasticSearch-Rest-客户端使用/</a>
    </li>
    
    <li class="post-copyright-license">
      <strong>版权声明： </strong> 本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by/4.0/deed.zh" target="_blank" rel="external">CC BY 4.0 CN协议</a> 许可协议。转载请注明出处！
    </li>
  </ul>
</blockquote>


<div class="panel panel-default panel-badger">
  <div class="panel-body">
    <figure class="media">
      <div class="media-left">
        <a href="https://github.com/sunlightzy" target="_blank" class="img-burn thumb-sm visible-lg">
          <img src="https://oscimg.oschina.net/oscnet/ec5be0d5bdd7e3094a04a246b07bc741ff7.jpg" class="img-rounded w-full" alt="">
        </a>
      </div>
      <div class="media-body">
        <h3 class="media-heading"><a href="https://github.com/sunlightzy" target="_blank"><span class="text-dark">Jerry Simple</span><small class="ml-1x">雨天配抄书,代码配咖啡</small></a></h3>
        <div>被编程耽误的歌手,业余艺术家</div>
      </div>
    </figure>
  </div>
</div>


    </div>
  </article>
  
    
  <section id="comments">
  	
      <div id="vcomments"></div>
    
  </section>


  
</div>

  <nav class="bar bar-footer clearfix" data-stick-bottom="">
  <div class="bar-inner">
  
  <ul class="pager pull-left">
    
    <li class="prev">
      <a href="/2018/06/22/Docker基本使用/" title="Docker基本使用"><i class="icon icon-angle-left" aria-hidden="true"></i><span>&nbsp;&nbsp;上一篇</span></a>
    </li>
    
    
    <li class="next">
      <a href="/2018/04/14/Mac后端开发环境搭建/" title="Mac后端开发环境搭建"><span>下一篇&nbsp;&nbsp;</span><i class="icon icon-angle-right" aria-hidden="true"></i></a>
    </li>
    
    
    <li class="toggle-toc">
      <a class="toggle-btn collapsed" data-toggle="collapse" href="#collapseToc" aria-expanded="false" title="文章目录" role="button">
        <span>[&nbsp;</span><span>文章目录</span>
        <i class="text-collapsed icon icon-anchor"></i>
        <i class="text-in icon icon-close"></i>
        <span>]</span>
      </a>
    </li>
    
  </ul>
  
  
  <!-- Button trigger modal -->
  <button type="button" class="btn btn-fancy btn-donate pop-onhover bg-gradient-warning" data-toggle="modal" data-target="#donateModal"><span>赏</span></button>
  <!-- <div class="wave-icon wave-icon-danger btn-donate" data-toggle="modal" data-target="#donateModal">
    <div class="wave-circle"><span class="icon"><i class="icon icon-bill"></i></span></div>
  </div> -->
  
  
  <div class="bar-right">
    
    <div class="share-component" data-sites="weibo,qq,wechat,facebook,twitter" data-mobile-sites="weibo,qq,qzone"></div>
    
  </div>
  </div>
</nav>
  
<!-- Modal -->
<div class="modal modal-center modal-small modal-xs-full fade" id="donateModal" tabindex="-1" role="dialog">
  <div class="modal-dialog" role="document">
    <div class="modal-content donate">
      <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
      <div class="modal-body">
        <div class="donate-box">
          <div class="donate-head">
            <p>感谢您的支持，我会继续努力的!</p>
          </div>
          <div class="tab-content">
            <div role="tabpanel" class="tab-pane fade active in" id="alipay">
              <div class="donate-payimg">
                <img src="https://oscimg.oschina.net/oscnet/581bf3b48ecae7688c440fcd5155296e900.jpg" alt="扫码支持" title="扫一扫">
              </div>
              <p class="text-muted mv">扫码打赏，你说多少就多少</p>
              <p class="text-grey">打开支付宝扫一扫，即可进行扫码打赏哦</p>
            </div>
            <div role="tabpanel" class="tab-pane fade" id="wechatpay">
              <div class="donate-payimg">
                <img src="https://oscimg.oschina.net/oscnet/0c82a0e906ef1016bd0d495e5da9162c5f9.jpg" alt="扫码支持" title="扫一扫">
              </div>
              <p class="text-muted mv">扫码打赏，你说多少就多少</p>
              <p class="text-grey">打开微信扫一扫，即可进行扫码打赏哦</p>
            </div>
          </div>
          <div class="donate-footer">
            <ul class="nav nav-tabs nav-justified" role="tablist">
              <li role="presentation" class="active">
                <a href="#alipay" id="alipay-tab" role="tab" data-toggle="tab" aria-controls="alipay" aria-expanded="true"><i class="icon icon-alipay"></i> 支付宝</a>
              </li>
              <li role="presentation" class="">
                <a href="#wechatpay" role="tab" id="wechatpay-tab" data-toggle="tab" aria-controls="wechatpay" aria-expanded="false"><i class="icon icon-wepay"></i> 微信支付</a>
              </li>
            </ul>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>



</main>

  <footer class="footer" itemscope="" itemtype="https://schema.org/WPFooter">
	
	
    <ul class="social-links">
    	
        <li><a href="https://github.com/sunlightzy" target="_blank" title="Github" data-toggle="tooltip" data-placement="top"><i class="icon icon-github"></i></a></li>
        
        <li><a href="/atom.xml" target="_blank" title="Rss" data-toggle="tooltip" data-placement="top"><i class="icon icon-rss"></i></a></li>
        
    </ul>

    <!-- <div class="copyright">
    	
        <div class="publishby">
        	Theme by <a href="https://github.com/cofess" target="_blank"> cofess </a>base on <a href="https://github.com/cofess/hexo-theme-pure" target="_blank">pure</a>.
        </div>
    </div> -->
</footer>
  <script src="https://cdn.bootcss.com/jquery/1.12.4/jquery.min.js"></script>
<script>
window.jQuery || document.write('<script src="https://cdn.bootcss.com/jquery/1.12.4/jquery.min.js"><\/script>')
</script>
<script src="/js/plugin.min.js"></script>
<script src="/js/application.js"></script>

    <script>
(function (window) {
    var INSIGHT_CONFIG = {
        TRANSLATION: {
            POSTS: '文章',
            PAGES: '页面',
            CATEGORIES: '分类',
            TAGS: '标签',
            UNTITLED: '(未命名)',
        },
        ROOT_URL: '/',
        CONTENT_URL: '/content.json',
    };
    window.INSIGHT_CONFIG = INSIGHT_CONFIG;
})(window);
</script>
<script src="/js/insight.js"></script>





   




   
    
  <script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/valine"></script>
  <script type="text/javascript">
  var GUEST = ['nick', 'mail', 'link'];
  var meta = 'nick,mail,link';
  meta = meta.split(',').filter(function(item) {
    return GUEST.indexOf(item) > -1;
  });
  new Valine({
    el: '#vcomments',
    verify: false,
    notify: false,
    appId: '',
    appKey: '',
    placeholder: 'Just go go',
    avatar: 'mm',
    meta: meta,
    pageSize: '10' || 10,
    visitor: false
  });
  </script>

     







</body>
</html>